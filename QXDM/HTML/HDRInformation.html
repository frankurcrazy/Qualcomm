<!doctype html public "-//w3c//dtd xhtml 1.0 strict//en" 
"http://www.w3.org/tr/xhtml1/dtd/xhtml1-strict.dtd">

<html>
<head>
   <meta name="vs_targetSchema" content="http://schemas.microsoft.com/intellisense/ie5" />
   <meta name="DMViewName" content="HDR Information" />
   <meta name="DMViewWidth" content="326" />
   <meta name="DMViewHeight" content="180" />
   <title>HDR Information</title>
   <link rel="stylesheet" href="QXDMStyle.css" />
</head>

<body onunload="Unregister()" onload="Register()">
<table width="100%" id="DataTable">
   <colgroup>
      <col width="60%" />
      <col width="40%" />
   </colgroup>
   <tr>
      <th>AT State</th>
      <td>-</td>
   </tr>
   <tr>
      <th>Serving Pilot PN</th>
      <td>-</td>
   </tr>
   <tr>
      <th>Predicted Pilot PN</th>
      <td>-</td>
   </tr>
   <tr>
      <th>Predicted Pilot SINR (dB)</th>
      <td>-</td>
   </tr>
   <tr>
      <th>DRC Rate Requested</th>
      <td>-</td>
   </tr>
   <tr>
      <th>Page Info</th>
      <td><input type="button" value="Reset" onclick="ResetPages();"></td>
   </tr>
   <tr>
      <th>Page Attempts</th>
      <td>-</td>
   </tr>
   <tr>
      <th>Orig. Sector PN</th>
      <td>-</td>
   </tr>
</table>

<script type="text/jscript" src="HelperFunctions.js"></script>
<script type="text/jscript">

var IQXDM2;
var Handle              = 0xFFFFFFFF;
var gMainTickID         = 0;

var TIMEOUT_MS          = 500;
var UPDATE_MS           = 1000;
var RESET_PAGE_REQ      = "CDMA 1xEV/Reset Page Messages Request";

var PrevIndex           = -1;
var gPrevSequenceNumber = -1;

// Ask the target to reset page statistics and then reset variables/table
function ResetPages()
{
   IQXDM2.RequestItem( RESET_PAGE_REQ, "", 1, TIMEOUT_MS, 1, 1 );
   DataTable.rows[6].cells[1].innerText = "-";
   DataTable.rows[7].cells[1].innerText = "-";
}

// Initialize the HTML page   
function Register()
{
   IQXDM2 = window.external;
   if (IQXDM2 == null)
   {
      window.document.write( "<br />QXDM does not support required interface" );
      return;
   }

   // We start by registering as a client
   Handle = IQXDM2.RegisterQueueClient( 256 );
   if (Handle == 0xFFFFFFFF)
   {
      window.document.write( "<br />Unable to register as client" );
   }   
   
   // Get a configuration object
   var clientObject = IQXDM2.ConfigureClientByKeys( Handle );

   if (clientObject == null)
   {
      window.document.write("<br />Failed to get client interface pointer");
      return;
   }

   // Configure logs
   clientObject.AddLog( 0x105F );
   clientObject.AddLog( 0x106F );
   clientObject.AddLog( 0x107E );
   clientObject.AddLog( 0x108C );
   clientObject.CommitConfig();
      
   // Setup the main update timer
   gMainTickID = setInterval( 'ProcessLogs()', UPDATE_MS );
}

// Clean up on unloading the page
function Unregister()
{
   if (gMainTickID != 0)
   {
      window.clearInterval( gMainTickID );
      gMainTickID = 0;
   }

   if (Handle != 0xFFFFFFFF)
   {
      IQXDM2.UnregisterClient( Handle );
   }
}

// Process the last received log
function ProcessLogs()
{
   var bLog105F = false;
   var bLog106F = false;
   var bLog107E = false;
   var bLog108C = false;   
   
   var CurrIndex = IQXDM2.GetClientItemCount( Handle ) - 1;
   if (PrevIndex > CurrIndex)
   {
      // Reset index if it is greater than item count
      PrevIndex = -1;
   }

   // Make sure there is an item
   if (CurrIndex < 0)
   {
      return;
   }  

   for (var i = CurrIndex; i > PrevIndex; i--)
   {   
      var Item = IQXDM2.GetClientItem( Handle, i );
      if (Item != null)
      {
         var ItemKey = Item.GetItemKeyText();
         switch (ItemKey)
         {              
            case "[0x105F]":
            {
               if (bLog105F == false)
               {
                  var Fields = Item.GetItemFields();
                  UpdateASPInfo( Fields );
               }
               
               bLog105F = true;         
            }            
            break;
            
            case "[0x106F]":
            {
               if (bLog106F == false)
               {
                  var Fields = Item.GetItemFields();
                  if (Fields != null && Fields.GetFieldCount() >= 3)
                  {
                     var Txt = Fields.GetFieldValueText( 1 );
                     DataTable.rows[6].cells[1].innerText = Txt;

                     Txt = Fields.GetFieldValueText( 2 );
                     DataTable.rows[7].cells[1].innerText = Txt;
                  }
               }
               
               bLog106F = true;         
            }            
            break;
            case "[0x107E]":
            {
               if (bLog107E == false)
               {
                  var Fields = Item.GetItemFields();
                  if (Fields != null && Fields.GetFieldCount() >= 1)
                  {
                     // AT State
                     DataTable.rows[0].cells[1].innerText 
                        = Fields.GetFieldValueText( 0 );
                  }
               }
               
               bLog107E = true;         
            }            
            break;
            
            case "[0x108C]":
            {
               if (bLog108C == false)
               {
                  var Fields = Item.GetItemFields();
                  if (Fields != null && Fields.GetFieldCount() > 3)
                  {
                     // DRC Rate Requested
                     DataTable.rows[4].cells[1].innerText 
                        = Fields.GetFieldValueText( 2 );
                  }
               }
               
               bLog108C = true;         
            }            
            break;
         } 
      }
   }
   
   PrevIndex = CurrIndex;
}

// Update ASP info related table cells from parsed fields
function UpdateASPInfo( Fields )
{  
   if (Fields == null || Fields.GetFieldCount() < 6)
   {
      return;
   }
   
   // Serving Pilot PN
   var Value = Fields.GetFieldValue( 5 );
   if (Value == 65535)
   {
      DataTable.rows[1].cells[1].innerText = "Invalid";
   }
   else
   {
      DataTable.rows[1].cells[1].innerText = Value;
   }
      
   // Predicted Pilot PN
   Value = Fields.GetFieldValue( 1 );
   if (Value == 65535)
   {
      DataTable.rows[2].cells[1].innerText = "Invalid";
      DataTable.rows[3].cells[1].innerText = "Invalid";
   } 
   else
   {
      DataTable.rows[2].cells[1].innerText = Value;
      
      // Predicted Pilot PN SINR
      Value = Fields.GetFieldValue( 4 );
      if (Value == 0)
      {
         DataTable.rows[3].cells[1].innerText = "Invalid";
      }
      else
      {
         Value = 10.0 * Math.LOG10E * Math.log( (Value / 512.0) );
         DataTable.rows[3].cells[1].innerText = Value.toFixed( 2 );
      }      
   }
}

</script>
</body>
</html>
