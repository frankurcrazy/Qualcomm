<!doctype html public "-//w3c//dtd xhtml 1.0 strict//en" 
"http://www.w3.org/tr/xhtml1/dtd/xhtml1-strict.dtd">

<html>

<head>
   <meta name="vs_targetSchema" content="http://schemas.microsoft.com/intellisense/ie5" />
   <meta name="DMViewName" content="WCDMA TFCS Uplink" />
   <meta name="DMViewWidth" content="480" />
   <meta name="DMViewHeight" content="200" />
   <title>WCDMA TFCS Uplink</title>
   <link rel="stylesheet" href="QXDMStyle.css" />
</head>

<body onunload="Unregister()" onload="Register()">

<table width="100%" id="ChannelTable">
   <colgroup span="9">
      <col width="12%" />
      <col width="11%" />
      <col width="11%" />
      <col width="11%" />
      <col width="11%" />
      <col width="11%" />
      <col width="11%" />
      <col width="11%" />
      <col width="11%" />      
   </colgroup>
   <tr>
      <th>Channel</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>      
   </tr>
   <tr>
      <td>ID</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <td>Type</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <td>TTI</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <th colspan="9">Uplink Transport Format Combinations</th>
      <tr>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
      </tr>      
   </tr>
</table>

<script type="text/jscript" src="HelperFunctions.js"></script>

<script type="text/jscript">

var IQXDM2;
var Handle         = 0xFFFFFFFF;
var gMainTickID    = 0;
var gChannels      = new Array();

var UPDATE_MS      = 1000;
var MAX_CHANNELS   = 8;
var MAX_TFCS       = 128;

var PrevIndex      = -1;

function Register()
{
   IQXDM2 = window.external;
   if (IQXDM2 == null)
   {
      window.document.write( "<br />QXDM does not support required interface" );
      return;
   }

   // We start by registering as a client
   Handle = IQXDM2.RegisterClient( "", 0 );
   if (Handle == 0xFFFFFFFF)
   {
      window.document.write( "<br />Unable to register as client" );
   }   
   
   // Get a configuration object
   var clientObject = IQXDM2.ConfigureClientByKeys( Handle );
   if (clientObject == null)
   {
      window.document.write("<br />Failed to get client interface pointer");
      return;
   }
         
   // Configure items
   clientObject.AddLog( 0x4117 );
   clientObject.AddLog( 0x4124 );

   clientObject.CommitConfig();
   
   // Setup the main update timer
   gMainTickID = setInterval( 'ProcessItems()', UPDATE_MS );
}

// Clean up on unloading the page
function Unregister()
{
   if (gMainTickID != 0)
   {
      window.clearInterval( gMainTickID );
      gMainTickID = 0;
   }

   if (Handle != 0xFFFFFFFF)
   {
      IQXDM2.UnregisterClient( Handle );
   }
}

// Process our client
function ProcessItems()
{
   var LogCode4117 = "[0x4117]";
   var LogCode4124 = "[0x4124]";
         
   var CurrIndex = IQXDM2.GetClientItemCount( Handle ) - 1;
   if (PrevIndex > CurrIndex)
   {
      // Reset index if it is greater than item count
      PrevIndex = -1;
   }

   // Make sure there is an item
   if (CurrIndex < 0 || CurrIndex == PrevIndex)
   {
      return;
   }

   for (var i = PrevIndex + 1; i <= CurrIndex; i++)
   {
      var Item = IQXDM2.GetClientItem( Handle, i );
      if (Item != null)
      {
         var Fields = Item.GetItemFields();
         if (Fields != null)
         {                        
            var ItemKey = Item.GetItemKeyText();
            switch (ItemKey)
            {              
               case LogCode4117:         
                  UpdateChannelTypes( Fields );
                  break;
               
               case LogCode4124:        
                  UpdateTable( Fields );         
                  break;
            }
         }
      }   
   }
   
   PrevIndex = CurrIndex;
}

function ResetTable()
{
   var Rows = ChannelTable.rows.length;
   for (var r = 1; r < 4; r++)
   {      
      for (var c = 1; c <= MAX_CHANNELS; c++)
      {
         ChannelTable.rows[r].cells[c].innerText = "-";
      }
   }
}

function UpdateChannelTypes( Fields )
{
   var FieldCount = Fields.GetFieldCount();
   if (FieldCount == 0)
   {
      return;
   }
   
   // Get number of transport channels
   var NumChannels = Fields.GetFieldValue( 0 ); 
   if (NumChannels > MAX_CHANNELS)
   {
      NumChannels = MAX_CHANNELS;
   }
   
   var Idx;
   var Name;
   
   for (var c = 0; c <= NumChannels; c++)
   {
      // First find the channel ID 
      Name = "Transport Channel[" + c + "].Transport Channel ID";
      Idx = Fields.GetFieldIndex( Name, 1 );
      if (Idx != 0xFFFFFFFF)
      {
         // The channel type follows the ID
         if (Idx + 1 < FieldCount)
         {
            gChannels[Fields.GetFieldValue( Idx )] 
               = Fields.GetFieldValueText( Idx + 1 );
         }
      }
   }
}

function UpdateTable( Fields )
{
   var FieldCount = Fields.GetFieldCount();
   if (FieldCount < 2)
   {
      return;
   }
    
   ResetTable();    
      
   // Get number of TFCs
   var NumTFCs = Fields.GetFieldValue( 0 ); 
   if (NumTFCs > MAX_TFCS)
   {
      NumTFCs = MAX_TFCS;
   }
 
   // Get number of transport channels
   var NumChannels = Fields.GetFieldValue( 1 ); 
   if (NumChannels > MAX_CHANNELS)
   {
      NumChannels = MAX_CHANNELS;
   }
     
   // Make sure we have enough fields
   if (FieldCount < (2 + 2 * NumChannels + NumTFCs * (1 + NumChannels)))
   {
      return;
   }   
     
   var FieldVal;
   var FI = 2;
   
   // Process channel IDs (and type from other log)  
   for (var c = 0; c < NumChannels; c++)
   {   
      // Channel ID
      FieldVal = Fields.GetFieldValue( FI++ );
      ChannelTable.rows[1].cells[1 + c].innerText = FieldVal;
      
      // Try to find channel ID in channel type array
      if (FieldVal in gChannels)
      {
         ChannelTable.rows[2].cells[1 + c].innerText = gChannels[FieldVal]; 
      }
   }
   
   // Process channel TTIs
   for (c = 0; c < NumChannels; c++)
   { 
      // TTI
      FieldVal = Fields.GetFieldValueText( FI++ );
      ChannelTable.rows[3].cells[1 + c].innerText = FieldVal;
   }
   
   var RO = 5;
   var CurRows = ChannelTable.rows.length;
   ManageRows( ChannelTable, RO, CurRows, NumTFCs, 9, true );
   
   // Process TFCs
   for (var t = 0; t < NumTFCs; t++)
   {
      // Skip format state
      FI++;
   
      for (c = 0; c <= MAX_CHANNELS; c++)
      {
         if (c == 0)
         {
            FieldVal = "TFCS[" + t + "]";
            ChannelTable.rows[RO + t].cells[c].innerText = FieldVal;
         }
         else
         {
            if (c <= NumChannels)
            {
               FieldVal = Fields.GetFieldValue( FI++ );
               ChannelTable.rows[RO + t].cells[c].innerText = FieldVal;
            }
            else
            {
               ChannelTable.rows[RO + t].cells[c].innerText = "-";
            }
         }
      }
   }
}

</script>
</body>
</html>