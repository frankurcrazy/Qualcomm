<!doctype html public "-//w3c//dtd xhtml 1.0 strict//en" 
"http://www.w3.org/tr/xhtml1/dtd/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <meta name="vs_targetSchema" content="http://schemas.microsoft.com/intellisense/ie5" />
   <meta name="DMViewName" content="WCDMA EUL E-DCH Active Set Statistics" />
   <meta name="DMViewWidth" content="400" />
   <meta name="DMViewHeight" content="100" />

   <title>WCDMA EUL E-DCH Active Set Statistics</title>
   <link rel="stylesheet" href="QXDMStyle.css" />
</head>

<body onunload="Unregister()" onload="Register()">

<table width="100%" id="DataTable">
   <colgroup span="2">
      <col width="60%" />
      <col width="40%" />
   </colgroup>
   <tr>
      <th colspan="2">E-DCH Active Set</th>
   </tr>   
   <tr>
      <th>Cell Average</th>
      <td>-</td>
   </tr>
   <tr>
      <th>Update Interval Average</th>
      <td>-</td>
   </tr>
</table>

<script type="text/jscript" src="HelperFunctions.js"></script>
<script type="text/jscript">

var IQXDM2;
var Handle              = 0xFFFFFFFF;
var gMainTickID         = 0;

var UPDATE_MS           = 100;
var PrevIndex           = -1;

var SECONDS_PER_DAY     = 86400.0;
var UPDATE_S            = UPDATE_MS / 1000.0;

var gTimestampLast      = -1;
var gNumCells           = 0;

var gCellTotal          = 0;
var gTimeTotal          = 0;

var gCellExtra          = 0;
var gTimeExtra          = 0;

var gNumIntervals       = 0;

var gbActive            = false;


function RoundDivide( Num, Den, Units )
{
   var Result = "-";
   if (isNaN( Num ) == false && isNaN( Den ) == false && Den != 0)
   {
      Result = (Num / Den).toFixed( 1 ) + Units;
   }
   return Result;
}

// Initialize the HTML page   
function Register()
{
   IQXDM2 = window.external;
   if (IQXDM2 == null)
   {
      window.document.write( "<br />QXDM does not support required interface" );
      return;
   }

   // We start by registering as a client
   Handle = IQXDM2.RegisterQueueClient( 256 );
   if (Handle == 0xFFFFFFFF)
   {
      window.document.write( "<br />Unable to register as client" );
   }   
   
   // Get a configuration object
   var clientObject = IQXDM2.ConfigureClientByKeys( Handle );
   if (clientObject == null)
   {
      window.document.write("<br />Failed to get client interface pointer");
      return;
   }
   
   // Configure event
   clientObject.AddEvent( 1210 );
   clientObject.CommitConfig();
   
   // Setup the main update timer
   gMainTickID = setInterval( 'ProcessItems()', UPDATE_MS );
}

// Clean up on unloading the page
function Unregister()
{
   if (gMainTickID != 0)
   {
      window.clearInterval( gMainTickID );
      gMainTickID = 0;
   }

   if (Handle != 0xFFFFFFFF)
   {
      IQXDM2.UnregisterClient( Handle );
   }
}

function ProcessItems()
{
   // Get any new events in client   
   var CurrIndex = IQXDM2.GetClientItemCount( Handle ) - 1;
   if (PrevIndex > CurrIndex)
   {
      // Reset index if it is greater than item count
      PrevIndex = -1;
   }

   // Make sure there is a new item
   if (CurrIndex >= 0 && CurrIndex != PrevIndex)
   {
      // Process all items
      for (var i = PrevIndex + 1; i <= CurrIndex; i++)
      {
         var Item = IQXDM2.GetClientItem( Handle, i );
         if (Item != null)
         {
            var Fields = Item.GetConfiguredItemFields( "", true, false );
            if (Fields != null)
            {
               // Use item specific timestamp to populate data
               var Timestamp = Item.GetItemSpecificTimestamp2();
               PopulateData( Fields, Timestamp );
            }
         }
      }
      
      PrevIndex = CurrIndex;
   }

   PopulateTable();
}
 
function PopulateData( Fields, Timestamp )
{
   var FieldCount = Fields.GetFieldCount();
   if (FieldCount < 6)
   {
      return;
   }

   if (Timestamp < gTimestampLast)
   {
      // Older timestamp received, reset
      gTimestampLast      = -1;
      gNumCells           = 0;

      gCellTotal          = 0;
      gTimeTotal          = 0;

      gCellExtra          = 0;
      gTimeExtra          = 0;

      gNumIntervals       = 0;

      gbActive            = false;
      
      DataTable.rows[1].cells[1].innerText = "-";
      DataTable.rows[2].cells[1].innerText = "-";
   }

   var Action = Fields.GetFieldValue( 0 );
   switch (Action)
   {
      case 0: // Start
      case 2: // Reconfigure ASET Change
      {
         if (gbActive == true)
         {
            // Add last interval, weighted based on time
            var Delta = (Timestamp - gTimestampLast) * SECONDS_PER_DAY;
            gCellTotal += gNumCells * Delta;
            gTimeTotal += Delta;
            gNumIntervals++;
         }
         
         // Store number of cells for current interval
         gNumCells = Fields.GetFieldValue( 1 );
         gbActive = true;
      }
      break;
      case 1: // Stop
      {
         if (gbActive == true)
         {
            // Add last interval, weighted based on time
            var Delta = (Timestamp - gTimestampLast) * SECONDS_PER_DAY;
            gCellTotal += gNumCells * Delta; 
            gTimeTotal += Delta;
            gNumIntervals++;
         }
         
         // No longer active
         gbActive = false; 
      }
      break;
      default:
      {
         // Ignore other actions
         return;
      }
   }

   // New current interval
   gCellExtra = 0;
   gTimeExtra = 0;

   gTimestampLast = Timestamp;
}

function PopulateTable()
{
   DataTable.rows[1].cells[1].innerText = RoundDivide( gCellTotal + gCellExtra,
                                                       gTimeTotal + gTimeExtra,
                                                       "" );
                                                       
   DataTable.rows[2].cells[1].innerText = RoundDivide( gTimeTotal, 
                                                       gNumIntervals, 
                                                       " s" );
   
   if (gbActive == true)
   {
      // Add update period to weight of current interval
      gCellExtra += gNumCells * UPDATE_S;
      gTimeExtra += UPDATE_S;
   }
}

</script>
</body>
</html>