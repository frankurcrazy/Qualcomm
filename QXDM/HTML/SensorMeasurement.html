<!doctype html public "-//w3c//dtd xhtml 1.0 strict//en"
"http://www.w3.org/tr/xhtml1/dtd/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <meta name="vs_targetSchema" content="http://schemas.microsoft.com/intellisense/ie5" />
   <meta name="DMViewName" content="Sensor Measurement" />
   <meta name="DMViewWidth" content="1200" />
   <meta name="DMViewHeight" content="280" />

   <title>Sensor Measurement</title>
   <link rel="stylesheet" href="QXDMStyle.css" />
</head>

<body onunload="Unregister()" onload="Register()">
<table border="0" width="100%" cellpadding="2">

   <tr>

      <td width="33%" valign="top" class="noborder">

         <div class="label">Calibration Status</div>
         <table width="100%" id="StatusTable">
            <colgroup span="2">
               <col width="60%" />
               <col width="40%" />
            </colgroup>
            <tr>
               <th></th>
               <th>Calibration</th>
            </tr>
            <tr>
               <th>Attitude : Roll</th>
               <td>-</td>
            </tr>
            <tr>
               <th>Attitude : Pitch</th>
               <td>-</td>
            </tr>
            <tr>
               <th>Attitude : Yaw</th>
               <td>-</td>
            </tr>
            <tr>
               <th>Acceleration</th>
               <td>-</td>
            </tr>
            <tr>
               <th>Turn Rate</th>
               <td>-</td>
            </tr>
         </table>

         <br />

         <div class="label">Device Attitude (SAE)</div>
         <table width="100%" id="AttitudeTable">
            <colgroup span="3">
               <col width="40%" />
               <col width="30%" />
               <col width="30%" />
            </colgroup>
            <tr>
               <th>Attitude</th>
               <th>Estimate</th>
               <th>Uncertainty</th>
            </tr>
            <tr>
               <th>Roll (deg)</th>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>Pitch (deg)</th>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>Yaw (deg)</th>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>At GPS TOW (wk:ms)</th>
               <td colspan="2">-</td>
            </tr>
         </table>

      </td>

      <td width="33%" valign="top" class="noborder">
         <div class="label">Calibrated Sensor Measurements (Body Frame)</div>
         <table width="100%" id="CalibratedTable">
            <colgroup span="4">
               <col width="30%" />
               <col width="30%" />
               <col width="20%" />
               <col width="20%" />
            </colgroup>
            <tr>
               <th>Acceleration</th>
               <th>Estimate</th>
               <th>Bias Estimate</th>
               <th>Bias Uncertainty</th>
            </tr>
            <tr>
               <th>X (m/s2)</th>
               <td>-</td>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>Y (m/s2)</th>
               <td>-</td>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>Z (m/s2)</th>
               <td>-</td>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>Turn Rate</th>
               <th>Estimate</th>
               <th>Bias Estimate</th>
               <th>Bias Uncertainty</th>
            </tr>
            <tr>
               <th>X (deg/s)</th>
               <td>-</td>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>Y (deg/s)</th>
               <td>-</td>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>Z (deg/s)</th>
               <td>-</td>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>At GPS TOW (wk:ms)</th>
               <td colspan="3">-</td>
            </tr>
         </table>
      </td>

      <td width="34%" valign="top" class="noborder">

         <div class="label">Raw Sensor Measurements (Body Frame)</div>
         <table width="100%" id="RawTable">
            <colgroup span="3">
               <col width="40%" />
               <col width="30%" />
               <col width="30%" />
            </colgroup>
            <tr>
               <th>Acceleration</th>
               <th>Raw Measurement</th>
               <th>Bias Correction</th>
            </tr>
            <tr>
               <th>X (m/s2)</th>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>Y (m/s2)</th>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>Z (m/s2)</th>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>Turn Rate</th>
               <th>Raw Measurement</th>
               <th>Bias Correction</th>
            </tr>
            <tr>
               <th>X (deg/s)</th>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>Y (deg/s)</th>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>Z (deg/s)</th>
               <td>-</td>
               <td>-</td>
            </tr>
            <tr>
               <th>Last Bias Calibration Mode</th>
               <td colspan="2">-</td>
            </tr>
            <tr>
               <th>Bias Update Count</th>
               <td colspan="2">-</td>
            </tr>
            <tr>
               <th>At GPS TOW (wk:ms)</th>
               <td colspan="2">-</td>
            </tr>
         </table>
      </td>

   </tr>
</table>

<script type="text/jscript" src="HelperFunctions.js"></script>
<script type="text/jscript">

var IQXDM2;
var Handle        = 0xFFFFFFFF;
var UPDATE_MS     = 1000;
var PrevIndex     = -1;
var CONV_CONST    = 57.2957795131;

var gMainTickID   = 0;

// Initialize the HTML page
function Register()
{
   IQXDM2 = window.external;
   if (IQXDM2 == null)
   {
      window.document.write( "<br />QXDM does not support required interface" );
      return;
   }

   // We start by registering as a client
   Handle = IQXDM2.RegisterQueueClient( 256 );
   if (Handle == 0xFFFFFFFF)
   {
      window.document.write( "<br />Unable to register as client" );
   }

   // Get a configuration object
   var ClientObject = IQXDM2.ConfigureClientByKeys( Handle );
   if (ClientObject == null)
   {
      window.document.write( "<br />Failed to get client interface pointer" );
      return;
   }

   // Configure Sensors log items
   ClientObject.AddLog( 0x13E1 );
   ClientObject.AddLog( 0x13E2 );
   ClientObject.AddLog( 0x13E3 );

   ClientObject.CommitConfig();

   // Setup the main update timer
   gMainTickID = setInterval( 'ProcessLogs()', UPDATE_MS );
}

// Clean up on unloading the page
function Unregister()
{
   if (gMainTickID != 0)
   {
      window.clearInterval( gMainTickID );
      gMainTickID = 0;
   }

   if (Handle != 0xFFFFFFFF)
   {
      IQXDM2.UnregisterClient( Handle );
   }
}

// Process our client
function ProcessLogs()
{
   var log13E1 = false;
   var log13E2 = false;

   var CurrIndex = IQXDM2.GetClientItemCount( Handle ) - 1;
   if (PrevIndex > CurrIndex)
   {
      // Reset index if it is greater than item count
      PrevIndex = -1;
   }

   // Make sure there is an item
   if (CurrIndex < 0)
   {
      return;
   }

   // Process items newest to oldest
   for (var i = CurrIndex; i > PrevIndex; i--)
   {
      var Item = IQXDM2.GetClientItem( Handle, i );
      if (Item == null)
      {
         continue;
      }

      var Fields = Item.GetConfiguredItemFields( "", true, false );
      if (Fields == null)
      {
         continue;
      }

      var ItemKey = Item.GetItemKeyText();
      switch (ItemKey)
      {
         case "[0x13E1]":
         {
            if (log13E1 == false)
            {
               PopulateAttitudeTable( Fields );
            }

            log13E1 = true;
         }
         break;

         case "[0x13E2]":
         {
            if (log13E2 == false)
            {
               PopulateRawTable( Fields );
            }

            log13E2 = true;
         }
         break;

         case "[0x13E3]":
         {
            UpdateBiasEntry( Fields );
         }
         break;
      }
   }

   PrevIndex = CurrIndex;
}

function PopulateAttitudeTable( Fields )
{
   if (Fields == null)
   {
      return;
   }

   var FieldCount = Fields.GetFieldCount();
   if (FieldCount < 60)
   {
      return;
   }

   var FieldVal;
   var Version = Fields.GetFieldValue( 0 );
   if (Version < 1 || Version > 3)
   {
      return;
   }

   // Attitude Roll Valid ?
   var ValidityFlag = Fields.GetFieldValue( 24 );
   if (ValidityFlag)
   {
      // Attitude Roll Estimate
      FieldVal = Fields.GetFieldValue( 27 );
      FieldVal *= CONV_CONST;
      FieldVal = FieldVal.toFixed( 6 );
      AttitudeTable.rows[1].cells[1].innerText = FieldVal;
      StatusTable.rows[1].cells[1].innerText = "Valid";

      // Attitude Roll Uncertainty
      FieldVal = Fields.GetFieldValue( 33 );
      FieldVal *= CONV_CONST;
      FieldVal = FieldVal.toFixed( 6 );
      AttitudeTable.rows[1].cells[2].innerText = FieldVal;
   }
   else
   {
      AttitudeTable.rows[1].cells[1].innerText = "NA";
      AttitudeTable.rows[1].cells[2].innerText = "NA";
      StatusTable.rows[1].cells[1].innerText = "Invalid";
   }

   // Attitude Pitch Valid ?
   ValidityFlag = Fields.GetFieldValue( 25 );
   if (ValidityFlag)
   {
      // Attitude Pitch Estimate
      FieldVal = Fields.GetFieldValue( 28 );
      FieldVal *= CONV_CONST;
      FieldVal = FieldVal.toFixed( 6 );
      AttitudeTable.rows[2].cells[1].innerText = FieldVal;
      StatusTable.rows[2].cells[1].innerText = "Valid";

      // Attitude Pitch Uncertainty
      FieldVal = Fields.GetFieldValue( 34 );
      FieldVal *= CONV_CONST;
      FieldVal = FieldVal.toFixed( 6 );
      AttitudeTable.rows[2].cells[2].innerText = FieldVal;
   }
   else
   {
      AttitudeTable.rows[2].cells[1].innerText = "NA";
      AttitudeTable.rows[2].cells[2].innerText = "NA";
      StatusTable.rows[2].cells[1].innerText = "Invalid";
   }

   // Attitude Yaw Valid ?
   ValidityFlag = Fields.GetFieldValue( 26 );
   if (ValidityFlag)
   {
      // Attitude Yaw Estimate
      FieldVal = Fields.GetFieldValue( 29 );
      FieldVal *= CONV_CONST;
      FieldVal = FieldVal.toFixed( 6 );
      AttitudeTable.rows[3].cells[1].innerText = FieldVal;
      StatusTable.rows[3].cells[1].innerText = "Valid";

      // Attitude Yaw Uncertainty
      FieldVal = Fields.GetFieldValue( 35 );
      FieldVal *= CONV_CONST;
      FieldVal = FieldVal.toFixed( 6 );
      AttitudeTable.rows[3].cells[2].innerText = FieldVal;
   }
   else
   {
      AttitudeTable.rows[3].cells[1].innerText = "NA";
      AttitudeTable.rows[3].cells[2].innerText = "NA";
      StatusTable.rows[3].cells[1].innerText = "Invalid";
   }

   // GPS Fix Millisecond
   var GPSMS = Fields.GetFieldValue( 2 );

   // GPS Fix Week Number
   FieldVal = Fields.GetFieldValue( 3 );

   AttitudeTable.rows[4].cells[1].innerText = FieldVal + " : " + GPSMS;

   var r, c;

   // Index of Acceleration field
   var f = 37;

   // Acceleration Valid ?
   ValidityFlag = Fields.GetFieldValue( 36 );
   if (ValidityFlag)
   {
      StatusTable.rows[4].cells[1].innerText = "Valid";
      for (c = 1; c <=3; c++)
      {
         for (r = 1; r <= 3; r++)
         {
            FieldVal = Fields.GetFieldValue( f++ );
            FieldVal = FieldVal.toFixed( 6 );
            CalibratedTable.rows[r].cells[c].innerText = FieldVal;
         }
      }
   }
   else
   {
      StatusTable.rows[4].cells[1].innerText = "Invalid";
      for (c = 1; c <=3; c++)
      {
         for (r = 1; r <= 3; r++)
         {
            CalibratedTable.rows[r].cells[c].innerText = "NA";
         }
      }
   }

   // Index of Turn Rate.Roll(X) field
   f = 47;

   // Turn Rate Valid ?
   ValidityFlag = Fields.GetFieldValue( 46 );
   if (ValidityFlag)
   {
      StatusTable.rows[5].cells[1].innerText = "Valid";
      for (c = 1; c <=3; c++)
      {
         for (r = 5; r <= 7; r++)
         {
            FieldVal = Fields.GetFieldValue( f++ );
            FieldVal *= CONV_CONST;
            FieldVal = FieldVal.toFixed( 6 );
            CalibratedTable.rows[r].cells[c].innerText = FieldVal;
         }
      }
   }
   else
   {
      StatusTable.rows[5].cells[1].innerText = "Invalid";
      for (c = 1; c <=3; c++)
      {
         for (r = 5; r <= 7; r++)
         {
            CalibratedTable.rows[r].cells[c].innerText = "NA";
         }
      }
   }

   // Sensor Measurement Millisecond
   var SensorMS = Fields.GetFieldValue( 4 );

   // Sensor Measurement Week Number
   FieldVal = Fields.GetFieldValue( 5 );

   CalibratedTable.rows[8].cells[1].innerText = FieldVal + " : " + SensorMS;
}

function PopulateRawTable( Fields )
{
   if (Fields == null)
   {
      return;
   }

   var FieldCount = Fields.GetFieldCount();
   if (FieldCount < 73)
   {
      return;
   }

   var FieldVal;
   var BiasCorrection;
   var Version = Fields.GetFieldValue( 0 );
   if (Version != 2)
   {
      return;
   }

   // Acceleration X Axis Valid ?
   var ValidityFlag = Fields.GetFieldValue( 6 );
   if (ValidityFlag)
   {
      FieldVal = Fields.GetFieldValue( 31 );
      BiasCorrection = Fields.GetFieldValue( 34 );
      FieldVal += BiasCorrection;

      RawTable.rows[1].cells[2].innerText = BiasCorrection.toFixed( 6 );
      RawTable.rows[1].cells[1].innerText = FieldVal.toFixed( 6 );
   }
   else
   {
      RawTable.rows[1].cells[1].innerText = "NA";
   }

   // Acceleration Y Axis Valid ?
   ValidityFlag = Fields.GetFieldValue( 7 );
   if (ValidityFlag)
   {
      FieldVal = Fields.GetFieldValue( 32 );
      BiasCorrection = Fields.GetFieldValue( 35 );
      FieldVal += BiasCorrection;

      RawTable.rows[2].cells[2].innerText = BiasCorrection.toFixed( 6 );
      RawTable.rows[2].cells[1].innerText = FieldVal.toFixed( 6 );
   }
   else
   {
      RawTable.rows[2].cells[1].innerText = "NA";
   }

   // Acceleration Z Axis Valid ?
   ValidityFlag = Fields.GetFieldValue( 8 );
   if (ValidityFlag)
   {
      FieldVal = Fields.GetFieldValue( 33 );
      BiasCorrection = Fields.GetFieldValue( 36 );
      FieldVal += BiasCorrection;

      RawTable.rows[3].cells[2].innerText = BiasCorrection.toFixed( 6 );
      RawTable.rows[3].cells[1].innerText = FieldVal.toFixed( 6 );
   }
   else
   {
      RawTable.rows[3].cells[1].innerText = "NA";
   }

   // Turn Rate X Axis Valid ?
   ValidityFlag = Fields.GetFieldValue( 9 );
   if (ValidityFlag)
   {
      FieldVal = Fields.GetFieldValue( 44 );
      BiasCorrection = Fields.GetFieldValue( 37 );
      FieldVal += BiasCorrection;
      FieldVal *= CONV_CONST;
      BiasCorrection *= CONV_CONST;

      RawTable.rows[5].cells[2].innerText = BiasCorrection.toFixed( 6 );
      RawTable.rows[5].cells[1].innerText = FieldVal.toFixed( 6 );
   }
   else
   {
      RawTable.rows[5].cells[1].innerText = "NA";
   }

   // Turn Rate Y Axis Valid ?
   ValidityFlag = Fields.GetFieldValue( 10 );
   if (ValidityFlag)
   {
      FieldVal = Fields.GetFieldValue( 45 );
      BiasCorrection = Fields.GetFieldValue( 38 );
      FieldVal += BiasCorrection;
      FieldVal *= CONV_CONST;
      BiasCorrection *= CONV_CONST;

      RawTable.rows[6].cells[2].innerText = BiasCorrection.toFixed( 6 );
      RawTable.rows[6].cells[1].innerText = FieldVal.toFixed( 6 );
   }
   else
   {
      RawTable.rows[6].cells[1].innerText = "NA";
   }

   // Turn Rate Z Axis Valid ?
   ValidityFlag = Fields.GetFieldValue( 11 );
   if (ValidityFlag)
   {
      FieldVal = Fields.GetFieldValue( 46 );
      BiasCorrection = Fields.GetFieldValue( 39 );
      FieldVal += BiasCorrection;
      FieldVal *= CONV_CONST;
      BiasCorrection *= CONV_CONST;

      RawTable.rows[7].cells[2].innerText = BiasCorrection.toFixed( 6 );
      RawTable.rows[7].cells[1].innerText = FieldVal.toFixed( 6 );
   }
   else
   {
      RawTable.rows[7].cells[1].innerText = "NA";
   }
}

function UpdateBiasEntry( Fields )
{
   if (Fields == null)
   {
      return;
   }

   var FieldCount = Fields.GetFieldCount();
   if (FieldCount < 13)
   {
      return;
   }

   var FieldVal;
   var Version = Fields.GetFieldValue( 0 );
   if (Version != 1)
   {
      return;
   }

   // Bias Count
   FieldVal = Fields.GetFieldValue( 10 );
   RawTable.rows[9].cells[1].innerText = FieldVal;

   // Integration Mode
   FieldVal = Fields.GetFieldValueText( 11 );
   RawTable.rows[8].cells[1].innerText = FieldVal;

   // GPS Fix Millisecond
   var GPSMS = Fields.GetFieldValue( 2 );

   // GPS Fix Week Number
   FieldVal = Fields.GetFieldValue( 3 );

   RawTable.rows[10].cells[1].innerText = FieldVal + " : " + GPSMS;
}

</script>
</body>
</html>