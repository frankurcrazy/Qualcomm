<!doctype html public "-//w3c//dtd xhtml 1.0 strict//en" 
"http://www.w3.org/tr/xhtml1/dtd/xhtml1-strict.dtd">

<html>
<head>
   <meta name="vs_targetSchema" content="http://schemas.microsoft.com/intellisense/ie5" />
   <meta name="DMViewName" content="CDMA Paging Message Error Rate" />
   <meta name="DMViewWidth" content="300" />
   <meta name="DMViewHeight" content="290" />
   <title>CDMA Paging Message Error Rate</title>
   <link rel="stylesheet" href="QXDMStyle.css" />
</head>

<body onunload="Unregister()" onload="Register()">

<table width="100%" id="StatsTable">
   <colgroup span="2">
      <col width="75%" />
      <col width="25%" />
   </colgroup>        
   <tr>
      <th colspan="2">MUX Paging Statistics</th>
   </tr>
   <tr>
      <td>General Page Matches</td>
      <td>-</td>
   </tr>
   <tr>
      <td>Slotted Page Matches</td>
      <td>-</td>
   </tr>
   <tr>
      <td>Low RSSI Indications</td>
      <td>-</td>
   </tr>
   
   <tr>
      <th colspan="2">CP Paging Statistics</th>
   </tr>
   <tr>
      <td>Real SCI (Assigned Slot)</td>
      <td>-</td>
   </tr>
   <tr>
      <td>Real SCI (After Assigned Slot)</td>
      <td>-</td>
   </tr>
   <tr>   
      <td>Telescoping SCI (Assigned Slot)</td>
      <td>-</td>
   </tr>
   <tr>
      <td>Telescoping SCI (After Assigned Slot)</td>
      <td>-</td>
   </tr>
   <tr>
      <td>Real Page Slots Seen</td>
      <td>-</td>
   </tr>
   <tr>
      <td>Telescoping Page Slots Seen</td>
      <td>-</td>
   </tr>

   <tr>
      <th colspan="2">Error Rates</th>
   </tr> 
   <tr>
      <td>Message Error Rate</td>
      <td>-</td>
   </tr>
   
   <tr>
      <th colspan="2">Options</th>
   </tr> 
   <tr>
      <td>
         Request Interval
         <select onchange="RequestStats( this.value );">
            <option value='1'>1 second</option>
            <option value='2' >2 seconds</option>
            <option value='5' >5 seconds</option>
            <option value='10'>10 seconds</option>
            <option value='30' selected>30 seconds</option>
         </select>
      </td>
      <td><input type="button" value="Reset" onclick="ResetStats();"></td>
   </tr>
</table>

<script type="text/jscript">

var IQXDM2;
var Handle            = 0xFFFFFFFF;
var TIMEOUT_MS        = 500;
var UPDATE_MS         = 1000;
var gMainTickID       = 0;
var gRequestIDs       = new Array;

var MUX_REQ           = "CDMA 1x MUX/Paging Statistics Request";
var CP_REQ            = "CDMA 1x Call Processing/Paging Message Error Rate Statistics Request";
var MUX_KEY           = "[0027/0001]";
var CP_KEY            = "[0030/0003]";

var PrevIndex         = -1;

// Initialize the HTML page       
function Register()
{      
   IQXDM2 = window.external;
   if (IQXDM2 == null)
   {
      window.document.write( "<br />QXDM does not support required interface" );
      return;
   }

   // We start by registering as a client
   Handle = IQXDM2.RegisterClient( "", 0 );
   if (Handle == 0xFFFFFFFF)
   {
      window.document.write( "<br />Unable to register as client" );
   }   
   
   // Get a configuration object
   var clientObject = IQXDM2.ConfigureClientByKeys( Handle );
   if (clientObject == null)
   {
      window.document.write("<br />Failed to get client interface pointer");
      return;
   }

   // Configure ourselves for the responses
   clientObject.AddSubsysResponse( 27, 1 );
   clientObject.AddSubsysResponse( 30, 3 );
   clientObject.CommitConfig();
   
   // Set up infinite requests to obtain the parameters
   RequestStats( 30 );
   if (gRequestIDs.length < 2)
   {
      window.document.write( "<br /> Error scheduling requests" );
      return;
   }       
   
   // Setup the main update timer
   gMainTickID = setInterval( 'ProcessResponses()', UPDATE_MS );
}

// Clean up on unloading the page
function Unregister()
{
   if (gMainTickID != 0)
   {
      window.clearInterval( gMainTickID );
      gMainTickID = 0;
   }
   
   // Remove all outstanding periodic requests
   for (var s = 0; s < gRequestIDs.length; ++s)
   {
      IQXDM2.RemoveRequest( gRequestIDs[s] );
   }

   if (Handle != 0xFFFFFFFF)
   {
      IQXDM2.UnregisterClient( Handle );
   }
}

// Set up a repetitive request for the required statistics
function RequestStats( Rate )
{
   // Assume failure
   var bOK = false;

   // Remove all outstanding periodic requests
   for (var s = 0; s < gRequestIDs.length; ++s)
   {
      IQXDM2.RemoveRequest( gRequestIDs[s] );
   }
   
   gRequestIDs = new Array;
   
   // Convert request rate to milliseconds
   Rate *= 1000;
   
   var ReqArgs = "1 1 1 1 1 1";
   var ReqID = IQXDM2.RequestItem( CP_REQ,
                                   ReqArgs,
                                   1,
                                   TIMEOUT_MS,
                                   0xFFFFFFFF,
                                   Rate );

   if (ReqID != 0)
   {
      gRequestIDs[gRequestIDs.length] = ReqID;
      bOK = true;
   }
   else
   {
      return bOK;
   }
   
   ReqArgs = "1 1 1";
   ReqID = IQXDM2.RequestItem( MUX_REQ,
                               ReqArgs,
                               1,
                               TIMEOUT_MS,
                               0xFFFFFFFF,
                               Rate );

   if (ReqID != 0)
   {
      gRequestIDs[gRequestIDs.length] = ReqID;
      bOK = true;
   }
  
   return bOK;
} 

// Reset statistics by sending out the appropriately formatted requests
function ResetStats()
{
   var ReqArgs = "0 0 0";
   IQXDM2.RequestItem( MUX_REQ, ReqArgs, 1, TIMEOUT_MS, 1, 1 );
   
   ReqArgs = "0 0 0 0 0 0";
   IQXDM2.RequestItem( CP_REQ, ReqArgs, 1, TIMEOUT_MS, 1, 1 );  
}

// Process new responses in our client view
function ProcessResponses()
{
   var CurrIndex = IQXDM2.GetClientItemCount( Handle ) - 1;
   if (PrevIndex > CurrIndex)
   {
      // Reset index if it is greater than item count
      PrevIndex = -1;
   }

   // Make sure there is an item
   if (CurrIndex < 0)
   {
      return;
   }  

   var KeyMUX = "";
   var KeyCP = ""

   for (var i = PrevIndex + 1; i <= CurrIndex; i++)
   {
      var Item = IQXDM2.GetClientItem( Handle, i );
      if (Item == null)
      {
         continue;
      }
      
      var Fields = Item.GetConfiguredItemFields( "", false, false );
      if (Fields == null)
      {
         continue;
      }
      
      var FieldCount = Fields.GetFieldCount();
      if (FieldCount <= 0)
      {
         continue;
      }      
      
      var ItemKey = Item.GetItemKeyText();
      if (ItemKey == MUX_KEY)
      {
         if (FieldCount >= 3)
         {
            StatsTable.rows[1].cells[1].innerText = Fields.GetFieldValue( 0 );
            StatsTable.rows[2].cells[1].innerText = Fields.GetFieldValue( 1 );
            StatsTable.rows[3].cells[1].innerText = Fields.GetFieldValue( 2 );
         }
         else
         {
            StatsTable.rows[1].cells[1].innerText = "-";
            StatsTable.rows[2].cells[1].innerText = "-"
            StatsTable.rows[3].cells[1].innerText = "-"; 
         }
      }
      else if (ItemKey == CP_KEY)
      {
         if (FieldCount >= 4)
         {
            StatsTable.rows[5].cells[1].innerText = Fields.GetFieldValue( 0 );
            StatsTable.rows[6].cells[1].innerText = Fields.GetFieldValue( 1 );
            StatsTable.rows[7].cells[1].innerText = Fields.GetFieldValue( 2 );
            StatsTable.rows[8].cells[1].innerText = Fields.GetFieldValue( 3 );
         }
         else
         {
            StatsTable.rows[5].cells[1].innerText = "-";
            StatsTable.rows[6].cells[1].innerText = "-";
            StatsTable.rows[7].cells[1].innerText = "-";
            StatsTable.rows[8].cells[1].innerText = "-";
         }
         
         // The last two fields were added to the end of the above at
         // a later date, hence the two step process
         if (FieldCount >= 6)
         {
            StatsTable.rows[9].cells[1].innerText = Fields.GetFieldValue( 4 );
            StatsTable.rows[10].cells[1].innerText = Fields.GetFieldValue( 5 );
         }
         else
         {
            StatsTable.rows[9].cells[1].innerText = "-";
            StatsTable.rows[10].cells[1].innerText = "-";
         }
      }
   }
   
   // Compute MER
   var MER = 0.0;
   
   if ( (StatsTable.rows[5].cells[1].innerText != "-")
   &&   (StatsTable.rows[7].cells[1].innerText != "-")
   &&   (StatsTable.rows[1].cells[1].innerText != "-")
   &&   (StatsTable.rows[9].cells[1].innerText != "-")
   &&   (StatsTable.rows[10].cells[1].innerText != "-") )
   {
      var gpm     = new Number( StatsTable.rows[1].cells[1].innerText );
      var rxReal  = new Number( StatsTable.rows[5].cells[1].innerText );
      var rxTele  = new Number( StatsTable.rows[7].cells[1].innerText );
      var numReal = new Number( StatsTable.rows[9].cells[1].innerText );
      var numTele = new Number( StatsTable.rows[10].cells[1].innerText );
      
      var num = rxReal + rxTele + gpm;
      var den = numReal + numTele;
      if (num > 0.0)
      {
         var raw = num / den;
         if (raw <= 1.0)
         {
            MER = 1.0 - raw;
            MER *= 100.0;
            
            var Txt = MER.toFixed( 2 );
            Txt += " %";
            StatsTable.rows[12].cells[1].innerText = Txt;
         }
         else
         {
            // Data is not coherent
            StatsTable.rows[12].cells[1].innerText = "0 %";
         }
      }
      else
      {
         // Nothing going on
         StatsTable.rows[12].cells[1].innerText = "0 %"; 
      }
   }
   else
   {
      // Not all data has arrived
      StatsTable.rows[12].cells[1].innerText = "?";
   }

   PrevIndex = CurrIndex;       
}

</script>

</body>
</html>
