<!doctype html public "-//w3c//dtd xhtml 1.0 strict//en" 
"http://www.w3.org/tr/xhtml1/dtd/xhtml1-strict.dtd">

<html>
<head>
   <meta name="vs_targetSchema" content="http://schemas.microsoft.com/intellisense/ie5" />
   <meta name="DMViewName" content="WCDMA BLER Cumulative" />
   <meta name="DMViewWidth" content="425" />
   <meta name="DMViewHeight" content="300" />
   <title>WCDMA BLER Cumulative</title>
   <link rel="stylesheet" href="QXDMStyle.css" />
</head>

<body onunload="Unregister()" onload="Register()">

<table width="100%" id="BLERTable">
   <colgroup span="7">
      <col width="10%" />
      <col width="15%" />
      <col width="15%" />
      <col width="15%" />
      <col width="15%" />
      <col width="15%" />
      <col width="15%" />
   </colgroup>
   <tr>
      <th colspan="2">Window Size</th>
      <th colspan="2">BLER All</th>
      <th colspan="2">BLER All Avg.</th>
      <th colspan="1">Options</th>
   </tr>
   <tr>
      <td colspan="2"">-</td>
      <td colspan="2"">-</td>
      <td colspan="2"">-</td>
      <td><input type="button" value="Reset" onclick="Reset();"></td>
   </tr>
   <tr>
      <th>ID</th>
      <th>RX</th>
      <th>Errs</th>
      <th>Total RX</th>
      <th>Total Errs</th>
      <th>BLER</th>
      <th>BLER Avg.</th>
   </tr>
   <tr>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   
</table>

<script type="text/jscript" src="HelperFunctions.js"></script>      
<script type="text/jscript">

var IQXDM2;
var Handle            = 0xFFFFFFFF;
var UPDATE_MS         = 1000;
var gMainTickID       = 0;
var PrevIndex         = -1;
        
// Maximum number of transport channels we process
var MAX_CHANNELS      = 8;
var BAD_CHANNEL       = 2048;
var Channels          = new Array();

var AllCRCTotal = 0;
var AllCRCError = 0;

// Construct a channel etry
function ChannelEntry( ID )
{
   this.ID       = ID;
   this.CRCTotal = 0;
   this.CRCError = 0;
   this.AvgTotal = 0; 
   this.AvgError = 0;
   this.Valid    = false;
}

// Initialize the HTML page
function Register()
{      
   IQXDM2 = window.external;
   if (IQXDM2 == null)
   {
      window.document.write( "<br />QXDM does not support required interface" );
      return;
   }

   // We start by registering as a client
   Handle = IQXDM2.RegisterClient( "", 0 );
   if (Handle == 0xFFFFFFFF)
   {
      window.document.write( "<br />Unable to register as client" );
   }   
   
   // Get a configuration object
   var clientObject = IQXDM2.ConfigureClientByKeys( Handle );
   if (clientObject == null)
   {
      window.document.write("<br />Failed to get client interface pointer");
      return;
   }

   // Configure logs     
   clientObject.AddLog( 0x4116 );   
   clientObject.CommitConfig();
   
   // Initialize the channels array
   for (var c = 0; c < MAX_CHANNELS; c++)
   {
      Channels[c] = new ChannelEntry( BAD_CHANNEL );
   }
    
   // Setup the main update timer
   gMainTickID = setInterval( 'ProcessLogs()', UPDATE_MS );
}

// Clean up on unloading the page
function Unregister()
{
   if (gMainTickID != 0)
   {
      window.clearInterval( gMainTickID );
      gMainTickID = 0;
   }

   if (Handle != 0xFFFFFFFF)
   {
      IQXDM2.UnregisterClient( Handle );
   }
}

// Process the last received log
function ProcessLogs()
{
   var CurrIndex = IQXDM2.GetClientItemCount( Handle ) - 1;
   if (PrevIndex > CurrIndex)
   {
      // Reset index if it is greater than item count
      PrevIndex = -1;
   }

   // Make sure there is an item
   if (CurrIndex < 0 || CurrIndex == PrevIndex)
   {
      return;
   }

   for (var i = PrevIndex + 1; i <= CurrIndex; i++)
   {
      var Item = IQXDM2.GetClientItem( Handle, i );
      if (Item != null)
      {
         var Fields = Item.GetItemFields();
         if (Fields != null)
         {
            UpdateChannels( Fields );
         }
      }
   }

   PrevIndex = CurrIndex;
}

// Update the channel array and table based on new fields
function UpdateChannels( Fields )
{  
   var FieldCount = Fields.GetFieldCount();
   if (FieldCount < 2)
   {
      return;
   }
   
   var ci = 0
   var cl = 0;
   var fi = 2;
   var ChIndex = -1;
   var FieldVal;
   
   var ChannelCount = Fields.GetFieldValue( 0 );
   
   FieldVal = Fields.GetFieldValueText( 1 );
   BLERTable.rows[1].cells[0].innerText = FieldVal;
   
   // Go through and mark all of our channels as invalid
   for (ci = 0; ci < MAX_CHANNELS; ci++)
   {
      Channels[ci].Valid = false;  
   }
   
   // Now add/update those found in log
   for (cl = 0; cl < ChannelCount; cl++)
   {
       // Grab channel ID
      FieldVal = Fields.GetFieldValue( fi );
      for (ci = 0; ci < MAX_CHANNELS; ci++)
      {
         if (Channels[ci].ID == FieldVal)
         {
            Channels[ci].Valid = true;
            break;
         }
      }
      
      fi += 3;
   }
   
   // Now free all invalid channels
   for (ci = 0; ci < MAX_CHANNELS; ci++)
   {
      if (Channels[ci].Valid == false)
      {
         Channels[ci].ID = BAD_CHANNEL;
         Channels[ci].CRCTotal = 0;
         Channels[ci].CRCError = 0;
         Channels[ci].AvgTotal = 0;
         Channels[ci].AvgError = 0; 
      }  
   }
   
   fi = 2;
   
   // Now add/update those found in log
   for (cl = 0; cl < ChannelCount; cl++)
   {   
      // Grab channel ID
      FieldVal = Fields.GetFieldValue( fi );
      
      // Find in our internal channel array
      ChIndex = -1;
      for (ci = 0; ci < MAX_CHANNELS; ci++)
      {
         if (Channels[ci].ID == FieldVal)
         {
            ChIndex = ci;
            break;
         }
      }
      
      // If we didn't find it then search for an empty slot
      if (ChIndex == -1)
      {
         for (ci = 0; ci < MAX_CHANNELS; ci++)
         {
            if (Channels[ci].ID == BAD_CHANNEL)
            {
               ChIndex = ci;
               break;
            }
         }
      }
      
      // Update if found
      if (ChIndex > -1 && ChIndex < MAX_CHANNELS)
      {
         Channels[ChIndex].ID = FieldVal;         
         Channels[ChIndex].CRCTotal += Fields.GetFieldValue( fi + 1 );
         Channels[ChIndex].CRCError += Fields.GetFieldValue( fi + 2 );
         Channels[ChIndex].AvgTotal += Channels[ci].CRCTotal;
         Channels[ChIndex].AvgError += Channels[ci].CRCError; 
         Channels[ChIndex].Valid = true;
      }
         
      // Three fields per channel
      fi += 3;
   }
   
   // From the updated internal table, populate the HTML
   for (ci = 0; ci < MAX_CHANNELS; ci++)
   {
      if (Channels[ci].Valid == true && Channels[ci].ID != BAD_CHANNEL)
      {
         BLERTable.rows[ci+ 3].cells[0].innerText = Channels[ci].ID;
         BLERTable.rows[ci+ 3].cells[1].innerText = Channels[ci].CRCTotal;
         BLERTable.rows[ci+ 3].cells[2].innerText = Channels[ci].CRCError;
         BLERTable.rows[ci+ 3].cells[3].innerText = Channels[ci].AvgTotal;
         BLERTable.rows[ci+ 3].cells[4].innerText = Channels[ci].AvgError;
         
         // Current average
         FieldVal = 0.0;
         if (Channels[ci].CRCTotal > 0)
         {
            FieldVal = Channels[ci].CRCError / Channels[ci].CRCTotal;
         }
         
         FieldVal = Precision( FieldVal, 2, true );
         BLERTable.rows[ci+ 3].cells[5].innerText = FieldVal;
         
         // Cumulative average
         FieldVal = 0.0;
         if (Channels[ci].AvgTotal > 0)
         {
            FieldVal = Channels[ci].AvgError / Channels[ci].AvgTotal;
         }
         
         FieldVal = Precision( FieldVal, 2, true );
         BLERTable.rows[ci+ 3].cells[6].innerText = FieldVal;              
      }
      else
      {
         BLERTable.rows[ci+ 3].cells[0].innerText = "-";
         BLERTable.rows[ci+ 3].cells[1].innerText = "-";
         BLERTable.rows[ci+ 3].cells[2].innerText = "-";
         BLERTable.rows[ci+ 3].cells[3].innerText = "-";
         BLERTable.rows[ci+ 3].cells[4].innerText = "-";
         BLERTable.rows[ci+ 3].cells[5].innerText = "-";
         BLERTable.rows[ci+ 3].cells[6].innerText = "-";
      }
   }
   
   // Compute the across all channels current BLER avg
   var CRCTotal = 0;
   var CRCError = 0; 
   for (ci = 0; ci < MAX_CHANNELS; ci++)
   {
      if (Channels[ci].Valid == true && Channels[ci].ID != BAD_CHANNEL)
      {
         CRCTotal += Channels[ci].CRCTotal;
         CRCError += Channels[ci].CRCError;
      }
   }
   
   FieldVal = 0.0;
   if (CRCTotal > 0)
   {
      FieldVal = CRCError / CRCTotal;
   }

   BLERTable.rows[1].cells[1].innerText = Precision( FieldVal, 2, true );
   
   // Compute the whole enchilada
   AllCRCTotal += CRCTotal;
   AllCRCError += CRCError;
   
   FieldVal = 0.0;
   if (AllCRCTotal > 0)
   {
      FieldVal = AllCRCError / AllCRCTotal;      
   }

   BLERTable.rows[1].cells[2].innerText = Precision( FieldVal, 2, true );   
   
   // Lastly reset instantaneous stats
   for (ci = 0; ci < MAX_CHANNELS; ci++)
   {
      Channels[ci].CRCTotal = 0;
      Channels[ci].CRCError = 0;
   }
}

// Reset the page
function Reset()
{
   AllCRCTotal = 0;
   AllCRCError = 0; 

   BLERTable.rows[1].cells[0].innerText = "-";
   BLERTable.rows[1].cells[1].innerText = "-";
   BLERTable.rows[1].cells[2].innerText = "-";

   for (var ci = 0; ci < MAX_CHANNELS; ci++)
   {
      Channels[ci].ID = BAD_CHANNEL;
      Channels[ci].CRCTotal = 0;
      Channels[ci].CRCError = 0;
      Channels[ci].AvgTotal = 0;
      Channels[ci].AvgError = 0;
       
      BLERTable.rows[ci + 3].cells[0].innerText = "-";
      BLERTable.rows[ci + 3].cells[1].innerText = "-";
      BLERTable.rows[ci + 3].cells[2].innerText = "-";
      BLERTable.rows[ci + 3].cells[3].innerText = "-";
      BLERTable.rows[ci + 3].cells[4].innerText = "-";
      BLERTable.rows[ci + 3].cells[5].innerText = "-";
      BLERTable.rows[ci + 3].cells[6].innerText = "-";
      
   }
}
 
</script>

</body>
</html>