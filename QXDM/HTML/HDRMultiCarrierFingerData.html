<!doctype html public "-//w3c//dtd xhtml 1.0 strict//en" 
"http://www.w3.org/tr/xhtml1/dtd/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <meta name="vs_targetSchema" content="http://schemas.microsoft.com/intellisense/ie5" />
   <meta name="DMViewName" content="HDR Multi Carrier Finger Data" />
   <meta name="DMViewWidth" content="700" />
   <meta name="DMViewHeight" content="500" />

   <title>HDR Multi Carrier Finger Data</title>
   <link rel="stylesheet" href="QXDMStyle.css" />
</head>

<body onunload="Unregister()" onload="Register()">

<div class="label-left">State Information</div>

<table width="70%" id="StateInfoTable">
   <colgroup span="2">
      <col width="70%" />
      <col width="30%" />
   </colgroup>
   
   <tr>
      <th>Parameter</th>
      <th>Value</th>
   </tr>

   <tr>
      <td>Search State</td>
      <td>-</td>
   </tr>
   <tr>
      <td>Offset from free running RTC timer in chipx8</td>
      <td>-</td>
   </tr>
   <tr> 
      <td>Offset of earliest finger from MSTR</td>
      <td>-</td>
   </tr>
   <tr>
      <td>Carrier ID, Channel Number, Band Class, PN</td>
      <td>-</td>
   </tr>
</table>     

<br />
<div class="label-left">Finger Information</div>

<table id="DataTable1" width="100%">
   <colgroup span="11">
      <col width="10%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
   </colgroup>
   
   <tr>
      <td class="noborder" colspan="11" style="text-align:left; font-weight:bold">Carrier 1</td>
   </tr>
   <tr>
      <th>PN</th>
      <th>RTC Offset</th>
      <th>C/I</th>
      <th>Locked</th>
      <th>Antenna</th>
      <th>Diversity</th>
      <th>Finger Idx</th>
      <th>RPC Cell Idx</th>
      <th>ASP Idx</th>
      <th>C/I (Ant0)</th>
      <th>C/I (Ant1)</th>
   </tr>
   
   <tbody id="FingerInfoTable1">
      <tr>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
      </tr>
   </tbody>
</table>
<br />
<table id="DataTable2" width="100%">
   <colgroup span="11">
      <col width="10%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
   </colgroup>
   
   <tr>
      <td class="noborder" colspan="11" style="text-align:left; font-weight:bold">Carrier 2</td>
   </tr>
   <tr>
      <th>PN</th>
      <th>RTC Offset</th>
      <th>C/I</th>
      <th>Locked</th>
      <th>Antenna</th>
      <th>Diversity</th>
      <th>Finger Idx</th>
      <th>RPC Cell Idx</th>
      <th>ASP Idx</th>
      <th>C/I (Ant0)</th>
      <th>C/I (Ant1)</th>
   </tr>
   
   <tbody id="FingerInfoTable2">
      <tr>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
      </tr>
   </tbody>
</table>
<br />
<table id="DataTable3" width="100%">
   <colgroup span="11">
      <col width="10%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
      <col width="9%" />
   </colgroup>
   
   <tr>
      <td class="noborder" colspan="11" style="text-align:left; font-weight:bold">Carrier 3</td>
   </tr>
   <tr>
      <th>PN</th>
      <th>RTC Offset</th>
      <th>C/I</th>
      <th>Locked</th>
      <th>Antenna</th>
      <th>Diversity</th>
      <th>Finger Idx</th>
      <th>RPC Cell Idx</th>
      <th>ASP Idx</th>
      <th>C/I (Ant0)</th>
      <th>C/I (Ant1)</th>
   </tr>
   
   <tbody id="FingerInfoTable3">
      <tr>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
         <td>-</td>
      </tr>
   </tbody>
</table>

<script type="text/jscript" src="HelperFunctions.js"></script>
<script type="text/jscript">

var IQXDM2;
var Handle         = 0xFFFFFFFF;
var gMainTickID    = 0;

var UPDATE_MS      = 1000;
var UNASSIGNED_STR = "Unassigned"
var UNASSIGNED_VAL = 0xFFFF;

var PrevIndex      = -1;

// Maximum number of carriers
var CARRIER_MAX = 3;

// Store carrier, indexed from oldest to newest (0 to 2)
var gCarrierOldest = new Array();

// Store current Carrier ID on each carrier 1, 2, 3
var gCarrierID = new Array();

for (var c = 0; c < CARRIER_MAX; c++)
{
   gCarrierOldest[c] = c;
   gCarrierID[c] = -1;
}

// Initialize the HTML page   
function Register()
{
   IQXDM2 = window.external;
   if (IQXDM2 == null)
   {
      window.document.write( "<br />QXDM does not support required interface" );
      return;
   }

   // We start by registering as a client
   Handle = IQXDM2.RegisterClient( "", 0 );
   if (Handle == 0xFFFFFFFF)
   {
      window.document.write( "<br />Unable to register as client" );
   }   
   
   // Get a configuration object
   var clientObject = IQXDM2.ConfigureClientByKeys( Handle );

   if (clientObject == null)
   {
      window.document.write("<br />Failed to get client interface pointer");
      return;
   }

   // Configure logs
   clientObject.AddLog( 0x1295 );
   clientObject.CommitConfig();
      
   // Setup the main update timer
   gMainTickID = setInterval( 'ProcessLogs()', UPDATE_MS );
}

// Clean up on unloading the page
function Unregister()
{
   if (gMainTickID != 0)
   {
      window.clearInterval( gMainTickID );
      gMainTickID = 0;
   }

   if (Handle != 0xFFFFFFFF)
   {
      IQXDM2.UnregisterClient( Handle );
   }
}

// Process last received log
function ProcessLogs()
{
   var CurrIndex = IQXDM2.GetClientItemCount( Handle ) - 1;
   if (PrevIndex > CurrIndex)
   {
      // Reset index if it is greater than item count
      PrevIndex = -1;
   }

   // Make sure there is a new item
   if (CurrIndex < 0 || CurrIndex == PrevIndex)
   {
      return;
   }
   
   var Item = IQXDM2.GetClientItem( Handle, CurrIndex );
   if (Item != null)
   {
      var Fields = Item.GetItemFields();
      if (Fields != null)
      {
         UpdateCellValues( Fields );
      }
   }
   
   PrevIndex = CurrIndex;
}
  
function ComputeRSSI( RSSI )
{
   var result = "N/A";
   if (RSSI > 0)
   {
      var inDB = 10 * Math.LOG10E * Math.log( (RSSI/256) );

      // Keep 2 decimal places
      result = Precision( inDB, 2, false );
   }
   
   return result;
}
    
function UpdateCellValues( Fields )
{  
   if (Fields == null)
   {
      return;
   }
        
   var FieldCount = Fields.GetFieldCount();
   if (FieldCount < 1)
   {
      return;
   }
     
   // Get version
   var Version = Fields.GetFieldValue( 0 );
   if (Version != 0 && Version != 1)
   {
      return;
   }
      
   if (FieldCount < 9)
   {
      return;
   }

   var FieldVal = Fields.GetFieldValueText( 1 );   
   StateInfoTable.rows[1].cells[1].innerText = FieldVal;    
   
   FieldVal = Fields.GetFieldValueText( 2 );   
   StateInfoTable.rows[2].cells[1].innerText = FieldVal;
   
   FieldVal = Fields.GetFieldValueText( 3 );   
   StateInfoTable.rows[3].cells[1].innerText = FieldVal;   

   var PNAsp = Fields.GetFieldValue( 4 );
   var PNCarrier = Fields.GetFieldValue( 5 );
   StateInfoTable.rows[4].cells[1].innerText = "-";   

   // Grab number of carriers
   var NumCarriers = Fields.GetFieldValue( 8 );

   // Field index - start at beginning of first carrier
   var fi = 9;

   for (var Carrier = 0; Carrier < NumCarriers; Carrier++)
   {
      if (FieldCount < fi + 5)
      {
         return;
      }

      // Get Carrier ID
      var CarrierID = Fields.GetFieldValue( fi );
      if (CarrierID == 0xFF)
      {
         // Ignore this Carrier ID
         continue;
      }

      // Get Channel Number
      var ChannelNumber = Fields.GetFieldValue( fi + 1 );

      // Get Band Class
      var BandClass = Fields.GetFieldValueText( fi + 2 );
      
      // Current Carrier (indexed from 0)
      var CC = -1;
      
      var bExist = false;
      for (var c = 0; c < CARRIER_MAX; c++)
      {
         if (CarrierID == gCarrierID[c])
         {
            bExist = true;
            CC = c;
            break;
         }
      }
      
      if (bExist == true)
      {
         for (var c = 0; c < CARRIER_MAX; c++)
         {
            if (CC == gCarrierOldest[c])
            {
               for (var j = c; j < 2; j++)
               {
                  gCarrierOldest[j] = gCarrierOldest[j + 1];
               }
            
               break;
            }
         }
      }
      else
      {
         CC = gCarrierOldest[0];
         gCarrierID[CC] = CarrierID;
         for (var c = 0; c < CARRIER_MAX - 1; c++)
         {
            gCarrierOldest[c] = gCarrierOldest[c + 1];
         }
      }

      gCarrierOldest[2] = CC;
      
      var FingerInfoTable;
      var DataTable;
      switch (CC)
      {
         case 0:
            FingerInfoTable = FingerInfoTable1;
            DataTable = DataTable1;
         break;
         case 1:
            FingerInfoTable = FingerInfoTable2;
            DataTable = DataTable2;
         break;
         case 2:
            FingerInfoTable = FingerInfoTable3;
            DataTable = DataTable3;
         break;
      }
      
      DataTable.rows[0].cells[0].innerText = "Carrier " + (CC + 1) + " (Carrier ID: " + CarrierID + ", Channel Number: " + ChannelNumber + ", Band Class: " + BandClass + ")"; 

      var RSSI;     
      var Diversity;
      var ColIndex = 0;

      // Grab number of rows in existing table
      var CurRows = FingerInfoTable.rows.length;
      
      // Grab number of fingers and process
      var NumFingers = Fields.GetFieldValue( fi + 4 );
      
      // Move to beginning of first finger
      fi += 5;
      
      var FieldOffset = 0;
      if (Version == 1)
      {
         FieldOffset = 2;
      }
      
      if (FieldCount < fi + NumFingers * (13 + FieldOffset))
      {
         return;
      }

      ManageRows( FingerInfoTable, 0, CurRows, NumFingers, 11, true );
      window.status = Carrier;
      for (var r = 0; r < NumFingers; r++)
      {
         // Pilot PN
         var PilotPN = Fields.GetFieldValue( fi + 0 );
         if (PilotPN == UNASSIGNED_VAL)
         {
            PilotPN = UNASSIGNED_STR;
         }
      
         FingerInfoTable.rows[r].cells[ColIndex++].innerText = PilotPN;
        
         // RTC offset
         FieldVal = Fields.GetFieldValueText( fi + 1 );
         FingerInfoTable.rows[r].cells[ColIndex++].innerText = FieldVal;
         
         // RSSI
         RSSI = Fields.GetFieldValue( fi + 2 );
         RSSI = ComputeRSSI( RSSI );
         FingerInfoTable.rows[r].cells[ColIndex++].innerText = RSSI
         
         // Lock
         FieldVal = Fields.GetFieldValueText( fi + 3 );
         FingerInfoTable.rows[r].cells[ColIndex++].innerText = FieldVal;
           
         // Antenna
         FieldVal = Fields.GetFieldValueText( fi + 4 );
         FingerInfoTable.rows[r].cells[ColIndex++].innerText = FieldVal;

         // Diversity
         Diversity = Fields.GetFieldValue( fi + 5 );
         FingerInfoTable.rows[r].cells[ColIndex++].innerText = Diversity;
         
         // Finger index
         FieldVal = Fields.GetFieldValueText( fi + 7 );
         FingerInfoTable.rows[r].cells[ColIndex++].innerText = FieldVal;

         // RPC cell index 
         FieldVal = Fields.GetFieldValueText( fi + 8 );
         FingerInfoTable.rows[r].cells[ColIndex++].innerText = FieldVal;

         // ASP index
         FieldVal = Fields.GetFieldValueText( fi + 10 );
         FingerInfoTable.rows[r].cells[ColIndex++].innerText = FieldVal;

         if (Carrier == PNCarrier && FieldVal == PNAsp)
         {   
            StateInfoTable.rows[4].cells[1].innerText = CarrierID + ", " + ChannelNumber + ", " + BandClass + ", " + PilotPN;   
         }
         
         // RSSI 0
         FieldVal = Fields.GetFieldValue( fi + 11 );
         if (Diversity == 1)
         {
            FieldVal = ComputeRSSI( FieldVal );
         }
         else
         {
            FieldVal = RSSI;
         }
         
         FingerInfoTable.rows[r].cells[ColIndex++].innerText = FieldVal;

         // RSSI 1
         FieldVal = Fields.GetFieldValue( fi + 12 );
         if (Diversity == 1)
         {
            FieldVal = ComputeRSSI( FieldVal );
         }
         else
         {
            FieldVal = "N/A";
         }
         
         FingerInfoTable.rows[r].cells[ColIndex++].innerText = FieldVal;

         // Move to next field after this finger
         fi += 13 + FieldOffset;
         ColIndex = 0;
      }
   }
   
   for (var Carrier = NumCarriers; Carrier < CARRIER_MAX; Carrier++)
   {
      // Reset this carrier
      var CC = gCarrierOldest[CARRIER_MAX - Carrier - 1];
      gCarrierID[CC] = -1;
      
      var FingerInfoTable;
      var DataTable;
      switch (CC)
      {
         case 0:
            FingerInfoTable = FingerInfoTable1;
            DataTable = DataTable1;
         break;
         case 1:
            FingerInfoTable = FingerInfoTable2;
            DataTable = DataTable2;
         break;
         case 2:
            FingerInfoTable = FingerInfoTable3;
            DataTable = DataTable3;
         break;
      }
      
      DataTable.rows[0].cells[0].innerText = "Carrier " + (CC + 1); 

      // Grab number of rows in existing table
      var CurRows = FingerInfoTable.rows.length;
      for (var r = CurRows - 1; r > 0 ; r--)
      {
         FingerInfoTable.deleteRow( r );
      }
      var CurCells = FingerInfoTable.rows[0].cells.length;
      for (var c = 0; c < CurCells; c++)
      {
         FingerInfoTable.rows[0].cells[c].innerText = "-"; 
      }
   }
}

</script>

</body>
</html>