<!doctype html public "-//w3c//dtd xhtml 1.0 strict//en" 
"http://www.w3.org/tr/xhtml1/dtd/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <meta name="vs_targetSchema" content="http://schemas.microsoft.com/intellisense/ie5" />
   <meta name="DMViewName" content="HDR Forward Statistics" />
   <meta name="DMViewWidth" content="840" />
   <meta name="DMViewHeight" content="400" />
   <title>HDR Forward Statistics</title>
   <link rel="stylesheet" href="QXDMStyle.css" />
</head>

<body onresize="Resize()" onunload="Unregister()" onload="Register()">
<table width="100%" id="DataTable">
   <tr>
      <th colspan="23">Forward Traffic Channel Statistics</th>
   </tr>
   <tr>
      <th colspan="3">DRC Info</th>
      <th colspan="3">CRC Count</th>
      <th colspan="17">Termination Slot Count</th>
   </tr>
   <tr>
      <th width="3%">Idx</th>
      <th width="4%">Kbps</th>
      <th width="6%">Format</th>
      <th width="6%">Passed</th>
      <th width="6%">Failed</th>
      <th width="6%">Total</th>
      <th width="3%">Avg</th>
      <th width="6%">1</th>
      <th width="6%">2</th>
      <th width="5%">3</th>
      <th width="5%">4</th>
      <th width="4%">5</th>
      <th width="4%">6</th>
      <th width="4%">7</th>
      <th width="4%">8</th>
      <th width="3.5%">9</th>
      <th width="3.5%">10</th>
      <th width="3.5%">11</th>
      <th width="3.5%">12</th>
      <th width="3.5%">13</th>
      <th width="3.5%">14</th>
      <th width="3.5%">15</th>
      <th width="3.5%">16</th>
   </tr>
   <tr>
      <td>1</td>
      <td>38.4</td>
      <td>1024, 16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <td>2</td>
      <td>76.8</td>
      <td>1024, 8</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td colspan="8"> &nbsp; </td>
   </tr>

   <tr>
      <td>3</td>
      <td>153.6</td>
      <td>1024, 4</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td colspan="12"> &nbsp; </td>
   </tr>
   
   <tr>
      <td>4</td>
      <td>307.2</td>
      <td>1024, 2</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td colspan="14"> &nbsp; </td>
   </tr>
   
   <tr>
      <td>5</td>
      <td>307.2</td>
      <td>2048, 4</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td colspan="12"> &nbsp; </td>
   </tr>
   
   <tr>
      <td>6</td>
      <td>614.4</td>
      <td>1024, 1</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>      
      <td colspan="15"> &nbsp; </td>
   </tr>
   
   <tr>
      <td>7</td>
      <td>614.4</td>
      <td>2048, 2</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td colspan="14"> &nbsp; </td>
   </tr>
   
   <tr>
      <td>8</td>
      <td>921.6</td>
      <td>3072, 2</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td colspan="14"> &nbsp; </td>
   </tr>
   
   <tr>
      <td>9</td>
      <td>1228.8</td>
      <td>2048, 1</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td colspan="15"> &nbsp; </td>
   </tr>
   
   <tr>
      <td>10</td>
      <td>1228.8</td>
      <td>4096, 2</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td colspan="14"> &nbsp; </td>
   </tr>
   
   <tr>
      <td>11</td>
      <td>1843.2</td>
      <td>3072, 1</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td colspan="15"> &nbsp; </td>
   </tr>
   
   <tr>
      <td>12</td>
      <td>2457.6</td>
      <td>4096, 1</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td colspan="15"> &nbsp; </td>
   </tr>
   
   <tr>
      <td colspan="3" class="shaded">Total</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td colspan="17"> &nbsp; </td>
   </tr>
   <tr>
      <th colspan="23">Forward Control Channel Statistics</th>
   </tr>
   <tr>
      <td>CC</td>
      <td>38.4</td>
      <td>1024, 16</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <td>CC</td>
      <td>76.8</td>
      <td>1024, 8</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td colspan="8"> &nbsp; </td>
   </tr>
   <tr>
      <td colspan="3" class="shaded">Total</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td colspan="17"> &nbsp; </td>
   </tr>
   <tr>
      <th colspan="23">General</th>
   </tr>
   <tr>
      <td colspan="6" class="shaded">Sequence Number (Elapsed Time Since Reset)</td>
      <td colspan="13">-</td>
      <td colspan="4"><input type="button" value="Reset Stats" onclick="ResetStats();" /></td>
   </tr>
</table>

<table style="position: absolute; z-index: 99; left: 400px; top: 180px" id="StatsTable">
   <tr>
      <td width="60%" class="shaded"> &nbsp; Packet Error Rate &nbsp; </td>
      <td width="30%">-</td>
   </tr>
   <tr>
      <td class="shaded"> &nbsp; Throughput When Served &nbsp; </td>
      <td>-</td>
   </tr>
   <tr>
      <td class="shaded"> &nbsp; Instantaneous Throughput &nbsp; </td>
      <td>-</td>
   </tr>
   <tr>
      <td class="shaded"> &nbsp; Instantaneous Throughput (1s) &nbsp; </td>
      <td>-</td>
   </tr>
</table>

<script type="text/jscript" src="HelperFunctions.js"></script>
<script type="text/jscript">

var IQXDM2;
var Handle              = 0xFFFFFFFF;
var gMainTickID         = 0;

var TIMEOUT_MS          = 500;
var UPDATE_MS           = 1000;
var RESET_STAT_REQ      = "CDMA 1xEV/Reset Forward Stats Request";

var PrevIndex           = -1;
var gEntries            = new Array();
var gPrevSequenceNumber = -1;
var gPrevControlNum     = 0;
var gPrevDataNum        = 0;

// Construct a transport format
function TransportFormat( PacketLen, Slots )
{
   // Fill out [a, b, c] of transport format, where
   //    a = Length of packet in bits
   //    b = Nominal transmit duration in slots
   //    c = Length of preamble in bits (not needed)
   this.PacketLen   = PacketLen;
   this.Slots       = Slots;
   
   // Initialize CRC success/failure counts
   this.CRCSuccesses = 0;
   this.CRCFailures  = 0;
   
   // Initialize early decode (by slot) counts
   this.EarlyDecodes = new Array();
   for (var s = 0; s < Slots; s++)
   {
      this.EarlyDecodes[s] = 0;
   }
}

// Construct a table entry
function TableEntry( IsDRC, TableRow, CRCIdx, EarlyDecodeIdx, Format )
{
   // Is this a DRC entry?
   this.IsDRC = IsDRC;

   // Row ID for entry in table (one, the summary, plus the number 
   // of transport format entries for a DRC entry, or simply the
   // later for the one and only control entry)
   this.TableRow = TableRow;
   
   // Field index for start of CRC info
   this.CRCIdx = CRCIdx;
   
   // Field index for start of early decode info
   this.EarlyDecodeIdx = EarlyDecodeIdx;
   
   // Transport format info (see above)
   this.Format = Format; 
}

// Initialize the internal variables
function InitializeTableEntries()
{   
   // DRC 1
   var DRC1Format = new TransportFormat( 1024, 16 );
   gEntries[1] = new TableEntry( true, 3, 4, 28, DRC1Format );
   
   // DRC 2
   var DRC2Format = new TransportFormat( 1024, 8 );
   gEntries[2] = new TableEntry( true, 4, 6, 44, DRC2Format );
   
   // DRC 3
   var DRC3Format = new TransportFormat( 1024, 4 );
   gEntries[3] = new TableEntry( true, 5, 8, 52, DRC3Format );
   
   // DRC 4
   var DRC4Format = new TransportFormat( 1024, 2 );
   gEntries[4] = new TableEntry( true, 6, 10, 56, DRC4Format );
   
   // DRC 5
   var DRC5Format = new TransportFormat( 2048, 4 );
   gEntries[5] = new TableEntry( true, 7, 12, 58, DRC5Format );
   
   // DRC 6
   var DRC6Format = new TransportFormat( 1024, 1 );
   gEntries[6] = new TableEntry( true, 8, 14, 62, DRC6Format );
   
   // DRC 7
   var DRC7Format = new TransportFormat( 2048, 2 );
   gEntries[7] = new TableEntry( true, 9, 16, 63, DRC7Format );
   
   // DRC 8
   var DRC8Format = new TransportFormat( 3072, 2 );
   gEntries[8] = new TableEntry( true, 10, 18, 65, DRC8Format );
   
   // DRC 9
   var DRC9Format = new TransportFormat( 2048, 1 );
   gEntries[9] = new TableEntry( true, 11, 20, 67, DRC9Format );
   
   // DRC 10
   var DRC10Format = new TransportFormat( 4096, 2 );
   gEntries[10] = new TableEntry( true, 12, 22, 68, DRC10Format );
   
   // DRC 11
   var DRC11Format = new TransportFormat( 3072, 1 );
   gEntries[11] = new TableEntry( true, 13, 24, 70, DRC11Format );
   
   // DRC 12
   var DRC12Format = new TransportFormat( 4096, 1 );
   gEntries[12] = new TableEntry( true, 14, 26, 71, DRC12Format );
   
   // Control
   var ControlFormat1 = new TransportFormat( 1024, 16 );
   gEntries[13] = new TableEntry( false, 17, 0, 72, ControlFormat1 ); 

   // Control
   var ControlFormat2 = new TransportFormat( 1024, 8 );
   gEntries[14] = new TableEntry( false, 18, 2, 88, ControlFormat2 ); 
}

// Initialize the HTML page   
function Register()
{
   IQXDM2 = window.external;
   if (IQXDM2 == null)
   {
      window.document.write( "<br />QXDM does not support required interface" );
      return;
   }

   // We start by registering as a client
   Handle = IQXDM2.RegisterQueueClient( 256 );
   if (Handle == 0xFFFFFFFF)
   {
      window.document.write( "<br />Unable to register as client" );
   }   
   
   // Get a configuration object
   var clientObject = IQXDM2.ConfigureClientByKeys( Handle );

   if (clientObject == null)
   {
      window.document.write("<br />Failed to get client interface pointer");
      return;
   }

   // Configure logs
   clientObject.AddLog( 0x1084 );
   clientObject.CommitConfig();
      
   // Initialize internal arrays
   InitializeTableEntries();
      
   // Set floating table position
   Resize();
      
   // Setup the main update timer
   gMainTickID = setInterval( 'ProcessLogs()', UPDATE_MS );
}

// Clean up on unloading the page
function Unregister()
{
   if (gMainTickID != 0)
   {
      window.clearInterval( gMainTickID );
      gMainTickID = 0;
   }

   if (Handle != 0xFFFFFFFF)
   {
      IQXDM2.UnregisterClient( Handle );
   }
}

// Set floating table position after a resize
function Resize()
{
   var posL = 0;
   var posT = 0;
   var anchorCell = DataTable.rows[7].cells[10]; 
   var currentNode = anchorCell;

   var zoomFactor = 1.0;
   if (document.body.style.zoom)
   {
      zoomFactor = document.body.style.zoom;
   }

   while (currentNode.tagName != "BODY")
   {
      posL += currentNode.offsetLeft;
      currentNode = currentNode.offsetParent;
   }
   
   posL *= zoomFactor;   
   posL += currentNode.offsetLeft;

   anchorCell = DataTable.rows[12].cells[0]; 
   currentNode = anchorCell;
      
   while (currentNode.tagName != "BODY")
   {
      posT += currentNode.offsetTop;      
      currentNode = currentNode.offsetParent;
   }

   posT *= zoomFactor;
   posT += currentNode.offsetTop;

   StatsTable.style.left = posL;
   StatsTable.style.top  = posT;
   
   // Apparently absolute positioned tables are not
   // affected by the <body> zoom setting so we set
   // it manually for the table
   StatsTable.style.zoom = zoomFactor;
}

// Process the last received log
function ProcessLogs()
{   
   var CurrIndex = IQXDM2.GetClientItemCount( Handle ) - 1;
   if (PrevIndex > CurrIndex)
   {
      // Reset index if it is greater than item count
      PrevIndex = -1;
   }

   // Make sure there is an item
   if (CurrIndex < 0 || CurrIndex == PrevIndex)
   {
      return;
   }  

   PrevIndex = CurrIndex;
   var Item = IQXDM2.GetClientItem( Handle, CurrIndex );
   if (Item == null)
   {
      return;
   }
  
   var Fields = Item.GetConfiguredItemFields( "", false, false );
   if (Fields != null)
   {
      UpdateForwardStats( Fields );
   }
   
   PrevIndex = CurrIndex;
}

// Ask the target to reset the statistics and then reset variables/table
function ResetStats()
{
   IQXDM2.RequestItem( RESET_STAT_REQ, "", 1, TIMEOUT_MS, 1, 1 );
   
   var e;
   var d;
   var r;
   var Decodes; 
   
   // Reset internal variables/table
   var Entries = gEntries.length;
   for (e = 1; e < Entries; e++)
   {  
      r = gEntries[e].TableRow;
      
      // CRC
      gEntries[e].Format.CRCSuccesses = 0;
      gEntries[e].Format.CRCFailures = 0;      
      DataTable.rows[r].cells[3].innerText = "-";
      DataTable.rows[r].cells[4].innerText = "-";
      DataTable.rows[r].cells[5].innerText = "-";
           
      // Decodes
      DataTable.rows[r].cells[6].innerText = "-";
      Decodes = gEntries[e].Format.EarlyDecodes.length;
      for (d = 0; d < Decodes; d++)
      {
         gEntries[e].Format.EarlyDecodes[d] = 0;
         DataTable.rows[r].cells[7 + d].innerText = "-";
      }
   }
   
   // CRC totals
   DataTable.rows[15].cells[1].innerText = "-";
   DataTable.rows[15].cells[2].innerText = "-";
   DataTable.rows[15].cells[3].innerText = "-";
   DataTable.rows[19].cells[1].innerText = "-";
   DataTable.rows[19].cells[2].innerText = "-";
   DataTable.rows[19].cells[3].innerText = "-";   
   
   // Throughputs
   StatsTable.rows[0].cells[1].innerText = "-";
   StatsTable.rows[1].cells[1].innerText = "-";
   StatsTable.rows[2].cells[1].innerText = "-";
   StatsTable.rows[3].cells[1].innerText = "-";

   // Sequence
   DataTable.rows[21].cells[1].innerText = "-";
   
   gPrevSequenceNumber = -1;
   gPrevDataNum        = 0;   
}

// Update forward statistics variables/table cells from parsed fields
function UpdateForwardStats( Fields )
{  
   if (Fields == null || Fields.GetFieldCount() < 97)
   {
      return;
   }

   // Get log sequence number
   var SequenceNumber = Fields.GetFieldValue( 96 );
      
   var e;
   var d;
   var fi1;
   var fi2;
   var r;
   var Value;
   var Decodes;
   
   var Total = 0;
   var DRCSuccessesAll = 0;
   var DRCFailuresAll  = 0;
   var CCSuccessesAll  = 0;
   var CCFailuresAll   = 0;
   
   var DecodeNum = 0;
   var DecodeDen = 0;
   
   // Fill in info for each transport format   
   var Entries = gEntries.length;
   for (e = 1; e < Entries; e++)
   {  

      fi1 = gEntries[e].CRCIdx;
      fi2 = gEntries[e].EarlyDecodeIdx;
      r = gEntries[e].TableRow;      
     
      // Successes
      Value = Fields.GetFieldValue( fi1 );
      gEntries[e].Format.CRCSuccesses = Value;
      DataTable.rows[r].cells[3].innerText = Value;
      
      Total = Value;
      if (gEntries[e].IsDRC == true)
      {
         DRCSuccessesAll += Value;
      }
      else
      {
         CCSuccessesAll += Value;
      }
      
      // Failures
      Value = Fields.GetFieldValue( fi1 + 1 );
      gEntries[e].Format.CRCFailures = Value;
      DataTable.rows[r].cells[4].innerText = Value;
               
      Total += Value;
      if (gEntries[e].IsDRC == true)
      {
         DRCFailuresAll += Value;
      }
      else
      {
         CCFailuresAll += Value;
      }
            
      DataTable.rows[r].cells[5].innerText = Total;

      DecodeNum = 0;
      DecodeDen = 0;

      // Early decodes
      Decodes = gEntries[e].Format.EarlyDecodes.length;
      for (d = 0; d < Decodes; d++)
      {
         Value = Fields.GetFieldValue( fi2++ );
         gEntries[e].Format.EarlyDecodes[d] = Value;
         DataTable.rows[r].cells[7 + d].innerText = Value;
         
         DecodeNum += ((d + 1) * Value);
         DecodeDen += Value;
      }
            
      if (DecodeDen > 0)
      {
         Value = DecodeNum / DecodeDen;         
         DataTable.rows[r].cells[6].innerText = Value.toFixed( 1 );
      }
      else
      {
         DataTable.rows[r].cells[6].innerText = "-";
      }
   }
   
   // Update totals - DRC
   Total = DRCSuccessesAll + DRCFailuresAll;
   DataTable.rows[15].cells[1].innerText = DRCSuccessesAll;
   DataTable.rows[15].cells[2].innerText = DRCFailuresAll;
   DataTable.rows[15].cells[3].innerText = Total;
   
   // We can also do the DRC PER here
   if (Total > 0)
   {
      var PER = DRCFailuresAll / Total;
      StatsTable.rows[0].cells[1].innerText = Precision( PER, 2, true );   
   }
   else
   {
      StatsTable.rows[0].cells[1].innerText = "-";
   }
   
   // Update totals - Control
   Total = CCSuccessesAll + CCFailuresAll;
   DataTable.rows[19].cells[1].innerText = CCSuccessesAll;
   DataTable.rows[19].cells[2].innerText = CCFailuresAll;
   DataTable.rows[19].cells[3].innerText = Total;
   
   // Update throughputs
   UpdateThroughputs( SequenceNumber );
   
   // Update elapsed time
   UpdateElapsedTime( SequenceNumber );
}

// Working form internal variables, update throughput rates
function UpdateThroughputs( SequenceNumber )
{
   var e;
   var d;
   var Num       = 0;
   var Den       = 0; 
   var Value1    = 0;
   var Value2    = 0;
   var Rate      = 0;
   var Decodes;
   
   var Entries = gEntries.length;
   for (e = 1; e < Entries; e++)
   {              
      if (gEntries[e].IsDRC == false)
      {
         // The control channels are the last entries, so break
         break;
      }
      
      Value1 = gEntries[e].Format.CRCSuccesses;
      Value1 *= gEntries[e].Format.PacketLen;         
      Num += Value1;
                  
      Value2 = gEntries[e].Format.CRCFailures;
      Value2 *= gEntries[e].Format.Slots;
      Den += Value2;
      
      Value1 = 0;
      Decodes = gEntries[e].Format.EarlyDecodes.length;        
      for (d = 0; d < Decodes; d++)
      {
         Value2 = gEntries[e].Format.EarlyDecodes[d];
         Value2 *= (d + 1);
         
         Value1 += Value2;
      }
      
      Den += Value1;
   }
   
   // Throughput (served)
   if (Den > 0)
   {
      Rate = ((600 * Num) / Den) / 1000;
      Rate = Precision( Rate, 2, false );
      StatsTable.rows[1].cells[1].innerText = Rate + " Kbps";
   }
   else
   {
      StatsTable.rows[1].cells[1].innerText = "0 Kbps";
   }
   
   // Throughput (average)
   if (SequenceNumber > 0)
   {
      Rate = (Num / SequenceNumber) / 1000;
      Rate = Precision( Rate, 2, false );         
      StatsTable.rows[2].cells[1].innerText = Rate + " Kbps";
   }
   else
   {
      StatsTable.rows[2].cells[1].innerText = "0 Kbps";
   }
   
   // Throughput (instantaneous)
   if (gPrevSequenceNumber >= 0 && SequenceNumber > gPrevSequenceNumber)
   {
      Value1 = Num - gPrevDataNum;
      Value2 = SequenceNumber - gPrevSequenceNumber;
      Rate = (Value1 / Value2) / 1000;
      Rate = Precision( Rate, 2, false );         
      StatsTable.rows[3].cells[1].innerText = Rate + " Kbps";
   }
   else
   {
      StatsTable.rows[3].cells[1].innerText = "0 Kbps";
   }
   
   gPrevDataNum = Num;
   gPrevSequenceNumber = SequenceNumber;
}

// Update the elapsed time from the given sequence number
function UpdateElapsedTime( SequenceNumber )
{
   // NOTE: A sequence number of '1' equals 1 second as
   // the logging second is given as 1 per second
   var Txt = SequenceNumber + " (";
   Txt += ElapsedSecondsToString( SequenceNumber );
   Txt += ")";
   
   DataTable.rows[21].cells[1].innerText = Txt;
}

</script>
</body>
</html>
