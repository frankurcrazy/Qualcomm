<!doctype html public "-//w3c//dtd xhtml 1.0 strict//en" 
"http://www.w3.org/tr/xhtml1/dtd/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <meta name="vs_targetSchema" content="http://schemas.microsoft.com/intellisense/ie5" />
   <meta name="DMViewName" content="WCDMA EUL L1 DL Configuration" />
   <meta name="DMViewWidth" content="450" />
   <meta name="DMViewHeight" content="215" />

   <title>WCDMA EUL L1 DL Configuration</title>
   <link rel="stylesheet" href="QXDMStyle.css" />
</head>

<body onunload="Unregister()" onload="Register()">

<table width="100%" id="ASETTable">
   <colgroup span="5">
      <col width="20%" />
      <col width="20%" />
      <col width="20%" />
      <col width="20%" />
      <col width="20%" />
   </colgroup>
   <tr>
      <th>ASET</th>
      <th>Cell 0</th>
      <th>Cell 1</th>
      <th>Cell 2</th>
      <th>Cell 3</th>
   </tr>
   <tr>
      <th>PSC</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <th>RG Index</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <th>TPC Index</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <th>OVSF</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
   <tr>
      <th>Type</th>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
   </tr>
</table>   
<br />
<table width="100%" id="DataTable">
   <colgroup span="2">
      <col width="40%" />
      <col width="60%" />
   </colgroup>
   <tr>
      <th>E-TTI</th>
      <td>-</td>
   </tr>
   <tr>
      <th>AGCH OVSF</th>
      <td>-</td>
   </tr>
   <tr>
      <th>Primary E-RNTI</th>
      <td>-</td>
   </tr>
   <tr>
      <th>Secondary E-RNTI</th>
      <td>-</td>
   </tr>
</table>   

<script type="text/jscript" src="HelperFunctions.js"></script>
<script type="text/jscript">

var IQXDM2;
var Handle              = 0xFFFFFFFF;
var gMainTickID         = 0;

var UPDATE_MS           = 1000;
var PrevIndex           = -1;

var STATE               = "[4]";
var LOG_ON_DEMAND_REQ   = "Log On Demand Request";
var SVR_STATE_CONNECTED = 2;
var TIMEOUT_MS          = 500;

// Initialize the HTML page   
function Register()
{
   IQXDM2 = window.external;
   if (IQXDM2 == null)
   {
      window.document.write( "<br />QXDM does not support required interface" );
      return;
   }

   // We start by registering as a client
   Handle = IQXDM2.RegisterQueueClient( 256 );
   if (Handle == 0xFFFFFFFF)
   {
      window.document.write( "<br />Unable to register as client" );
   }   
   
   // Get a configuration object
   var clientObject = IQXDM2.ConfigureClientByKeys( Handle );

   if (clientObject == null)
   {
      window.document.write("<br />Failed to get client interface pointer");
      return;
   }

   // Configure connection string
   clientObject.AddString( 4 );

   // Configure logs
   clientObject.AddLog( 0x4301 );
   clientObject.CommitConfig();
      
   // Are we currently connected
   var ServerState = IQXDM2.GetServerState();
   if (ServerState == SVR_STATE_CONNECTED)
   {
      // Request log
      IQXDM2.RequestItem( LOG_ON_DEMAND_REQ, 
                          "0x4301", 
                          1,
                          TIMEOUT_MS, 
                          1,
                          1 );
   }
   
   // Setup the main update timer
   gMainTickID = setInterval( 'ProcessLogs()', UPDATE_MS );
}

// Clean up on unloading the page
function Unregister()
{
   if (gMainTickID != 0)
   {
      window.clearInterval( gMainTickID );
      gMainTickID = 0;
   }

   if (Handle != 0xFFFFFFFF)
   {
      IQXDM2.UnregisterClient( Handle );
   }
}

function ProcessLogs()
{
   var CurrIndex = IQXDM2.GetClientItemCount( Handle ) - 1;
   if (PrevIndex > CurrIndex)
   {
      // Reset index if it is greater than item count
      PrevIndex = -1;
   }

   // Make sure there is a new item
   if (CurrIndex < 0 || CurrIndex == PrevIndex)
   {
      return;
   }
   
   var bFound = false;
   for (var i = CurrIndex; i > PrevIndex; i--)
   {
      var Item = IQXDM2.GetClientItem( Handle, i );
      if (Item != null)
      {
         // Check for a state notification 
         var ItemKey = Item.GetItemKeyText();
         if (ItemKey == STATE)
         {
            var ServerState = IQXDM2.GetServerState();
            if (ServerState == SVR_STATE_CONNECTED)
            {
               var Txt = Item.GetItemSummary();

               var bConnect = (Txt.indexOf( "Connected to" ) >= 0);
               if (bConnect == true)
               {  
                  // Request log
                  IQXDM2.RequestItem( LOG_ON_DEMAND_REQ, 
                                      "0x4301", 
                                      1,
                                      TIMEOUT_MS, 
                                      1,
                                      1 );
               }
            }
         }
         else if (bFound == false)
         {      
            var Item = IQXDM2.GetClientItem( Handle, CurrIndex );
            if (Item != null)
            {
               var Fields = Item.GetConfiguredItemFields( "", true, false );
               if (Fields != null)
               {
                  PopulateTable( Fields );
                  bFound = true;
               }
            }
         }
      }
   }
         
   PrevIndex = CurrIndex;
}
 
function PopulateTable( Fields )
{  
   var FieldCount = Fields.GetFieldCount();
   if (FieldCount < 16)
   {
      return;
   }

   // TTI
   var FieldVal = Fields.GetFieldValueText( 15 );   
   DataTable.rows[0].cells[1].innerText = FieldVal;

   // AGCH OVSF
   FieldVal = Fields.GetFieldValueText( 6 );   
   DataTable.rows[1].cells[1].innerText = FieldVal;    
   
   // Primary E-RNTI
   FieldVal = Fields.GetFieldValue( 3 );
   if (FieldVal != 0)
   {
      FieldVal = Fields.GetFieldValueText( 10 );
   }
   else
   {
      FieldVal = "-";
   }
   DataTable.rows[2].cells[1].innerText = FieldVal;    
   
   // Secondary E-RNTI
   FieldVal = Fields.GetFieldValue( 4 );
   if (FieldVal != 0)
   {
      FieldVal = Fields.GetFieldValueText( 11 );
   }
   else
   {
      FieldVal = "-";
   }
   DataTable.rows[3].cells[1].innerText = FieldVal;    
   
   var NumCells = Fields.GetFieldValue( 0 );
   if (FieldCount < 16 + 22 * NumCells)
   {
      return;
   }
   
   if (NumCells > 4)
   {
      NumCells = 4;
   }
   
   var fi = 16;
   var RlsIdxServing = -1;
   for (var i = 0; i < NumCells; i++)
   {
      // Search for serving cell
      var ServingCell = Fields.GetFieldValue( fi + 2 );
      if (ServingCell == 1)
      {
         // Store index
         RlsIdxServing = Fields.GetFieldValue( fi + 1 );
         break;
      }
      
      fi += 22;
   }
   
   fi = 16;
   for (var i = 0; i < NumCells; i++)
   {
      var ServingCell = Fields.GetFieldValue( fi + 2 );

      // PSC
      FieldVal = Fields.GetFieldValueText( fi + 9 );   
      ASETTable.rows[1].cells[i + 1].innerText = FieldVal;

      // RLS Index
      var RlsIdx = Fields.GetFieldValue( fi + 1 );
      FieldVal = RlsIdx;
      if (RlsIdx == 7)
      {
         FieldVal = "Not Configured";
      }

      ASETTable.rows[2].cells[i + 1].innerText = FieldVal;

      // TPC Index
      FieldVal = Fields.GetFieldValueText( fi + 3 );   
      ASETTable.rows[3].cells[i + 1].innerText = FieldVal;
      
      // HICH OVSF
      FieldVal = Fields.GetFieldValueText( fi + 11 );   
      ASETTable.rows[4].cells[i + 1].innerText = FieldVal;
      
      // Type
      if (ServingCell == 1)
      {
         FieldVal = "S-Cell";
      }
      else if (RlsIdxServing == RlsIdx)
      {
         FieldVal = "S-RLS";
      }
      else
      {
         FieldVal = "NS-RLS";
      }
      ASETTable.rows[5].cells[i + 1].innerText = FieldVal;
      
      // Check if actions are disabled
      var ActionRGCH = Fields.GetFieldValue( fi + 4 );
      var ActionHICH = Fields.GetFieldValue( fi + 6 );
      if (ActionRGCH == 0)
      {
         // Disable RG field
         ASETTable.rows[2].cells[i + 1].innerText = "-";
         if (ActionHICH == 0)
         {
            // Disable remaining fields
            ASETTable.rows[1].cells[i + 1].innerText = "-";
            ASETTable.rows[3].cells[i + 1].innerText = "-";
            ASETTable.rows[4].cells[i + 1].innerText = "-";
            ASETTable.rows[5].cells[i + 1].innerText = "Disabled";
         }
      }
      
      fi += 22;
   }
   
   for (var i = NumCells; i < 4; i++)
   {
      // Clear any empty cells
      FieldVal = "-";

      for (var j = 1; j <=5; j++)
      {         
         ASETTable.rows[j].cells[i + 1].innerText = FieldVal;
      }
   }
}

</script>
</body>
</html>